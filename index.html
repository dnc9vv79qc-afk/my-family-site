<html lang="ja"><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>é–“å–ã‚Šæ¤œè¨ã‚µã‚¤ãƒˆï¼ˆIchijo) v6.12</title>
Â 
<style>
:root{
Â Â --accent:#007AFF;
Â Â --danger:#ff3b30;
Â Â --measure:#FF2D55; /* è¨ˆæ¸¬ç”¨ã‚«ãƒ©ãƒ¼ */
Â Â --bg:#f2f2f7;
Â Â --card: rgba(255,255,255,.72);
Â Â --stroke: rgba(60,60,67,.18);
Â Â --text:#111;
Â Â --muted: rgba(60,60,67,.6);
Â Â --shadow: 0 10px 30px rgba(0,0,0,.10);
Â Â --radius2: 26px;
}
Â 
@media (prefers-color-scheme: dark){
Â Â :root{
Â Â Â Â --bg:#000;
Â Â Â Â --card: rgba(28,28,30,.68);
Â Â Â Â --stroke: rgba(84,84,88,.55);
Â Â Â Â --text:#fff;
Â Â Â Â --muted: rgba(235,235,245,.6);
Â Â Â Â --shadow: 0 16px 50px rgba(0,0,0,.45);
Â Â }
}
Â 
*{ box-sizing: border-box; }
Â 
body{
Â Â font-family:
Â Â Â Â -apple-system, BlinkMacSystemFont,
Â Â Â Â "SF Pro Display", "SF Pro Text",
Â Â Â Â "Hiragino Sans", "Hiragino Kaku Gothic ProN",
Â Â Â Â "Noto Sans JP",
Â Â Â Â "Yu Gothic", "YuGothic",
Â Â Â Â "Meiryo",
Â Â Â Â sans-serif;
Â Â -webkit-font-smoothing: antialiased;
Â Â text-rendering: optimizeLegibility;
Â 
Â Â margin: 0;
Â Â background: var(--bg);
Â Â color: var(--text);
Â Â touch-action: none;
Â Â display: flex;
Â Â flex-direction: column;
Â Â height: 100vh;
Â Â overflow: hidden;
}
Â 
.ver-label{
Â Â position: fixed;
Â Â top: 6px;
Â Â right: 10px;
Â Â font-size: 10px;
Â Â color: var(--muted);
Â Â z-index: 100;
Â Â pointer-events: none;
Â Â font-weight: 800;
Â Â text-align: right;
Â Â opacity: .85;
}
Â 
/* ===== Top bar ===== */
.toolbar{
Â Â margin: 12px;
Â Â border-radius: var(--radius2);
Â Â background: var(--card);
Â Â border: 1px solid var(--stroke);
Â Â box-shadow: var(--shadow);
Â Â backdrop-filter: blur(16px);
Â Â -webkit-backdrop-filter: blur(16px);
Â 
Â Â padding: 10px;
Â Â display:flex;
Â Â align-items:center;
Â Â justify-content: space-between;
Â Â gap: 10px;
Â 
Â Â z-index: 10;
}
.top-left, .top-right{ display:flex; align-items:center; gap: 10px; }
.top-title{ font-weight: 900; font-size: 13px; letter-spacing: .3px; opacity: .9; user-select:none; }
Â 
button{
Â Â height: 44px;
Â Â font-size: 13px;
Â Â border: none;
Â Â border-radius: 16px;
Â Â color: white;
Â Â font-weight: 900;
Â Â cursor: pointer;
Â Â display: inline-flex;
Â Â align-items: center;
Â Â justify-content: center;
Â Â padding: 0 14px;
Â Â -webkit-tap-highlight-color: transparent;
Â Â letter-spacing: .2px;
Â Â transition: transform .08s ease, filter .08s ease, opacity .08s ease;
}
button:active { opacity: 0.85; transform: scale(0.98); }
Â 
.btn-primary{ background: rgba(255,149,0,.95); }
.btn-help{
Â Â background: rgba(120,120,128,.18);
Â Â color: var(--text);
Â Â font-size: 18px;
Â Â width: 44px;
Â Â padding: 0;
}
Â 
.color-circle{
Â Â background: rgba(120,120,128,.18);
Â Â border: 1px solid var(--stroke);
Â Â border-radius: 16px;
Â Â width: 44px;
Â Â height: 44px;
Â Â display:flex;
Â Â align-items:center;
Â Â justify-content:center;
Â Â overflow:hidden;
}
input[type="color"]{
Â Â width: 70px;
Â Â height: 70px;
Â Â border: none;
Â Â background: none;
Â Â cursor: pointer;
Â Â padding: 0;
}
Â 
/* ===== Config bar ===== */
.config-bar{
Â Â margin: 0 12px 12px;
Â Â border-radius: var(--radius2);
Â Â background: var(--card);
Â Â border: 1px solid var(--stroke);
Â Â box-shadow: var(--shadow);
Â Â backdrop-filter: blur(16px);
Â Â -webkit-backdrop-filter: blur(16px);
Â 
Â Â padding: 10px;
Â Â display:flex;
Â Â justify-content: space-between;
Â Â align-items:center;
Â Â gap: 10px;
}
Â 
.chip-group { display: flex; gap: 6px; flex-wrap: wrap; }
.chip{
Â Â background: rgba(255,255,255,.55);
Â Â border: 1px solid var(--stroke);
Â Â padding: 8px 12px;
Â Â border-radius: 999px;
Â Â font-size: 13px;
Â Â font-weight: 900;
Â Â display:flex;
Â Â align-items:center;
Â Â gap: 6px;
Â Â box-shadow: 0 1px 6px rgba(0,0,0,.06);
Â Â cursor: pointer;
Â Â color: var(--text);
}
@media (prefers-color-scheme: dark){
Â Â .chip{ background: rgba(44,44,46,.65); }
}
.chip input { margin: 0; width: 18px; height: 18px; }
Â 
.right-actions{
Â Â display:flex;
Â Â align-items:center;
Â Â gap: 10px;
Â Â flex-wrap: wrap;
Â Â justify-content: flex-end;
}
Â 
.segment{
Â Â display:flex;
Â Â align-items: center;
Â Â border: 1px solid var(--stroke);
Â Â border-radius: 14px;
Â Â background: rgba(120,120,128,.12);
Â Â padding: 2px;
Â Â height: 36px;
}
.seg-btn{
Â Â height: 32px;
Â Â min-width: 56px;
Â Â padding: 0 12px;
Â Â border-radius: 12px;
Â Â background: transparent;
Â Â color: var(--text);
Â Â font-size: 12px;
Â Â font-weight: 900;
Â Â line-height: 1;
Â Â box-shadow:none;
Â Â white-space: nowrap;
}
.seg-btn.active{ background: var(--accent); color: #fff; }
.seg-btn:active{ transform: none; }
Â 
.small-btn{
Â Â height: 34px;
Â Â border-radius: 999px;
Â Â padding: 0 12px;
Â Â background: var(--accent);
Â Â color:#fff;
Â Â font-size: 12px;
Â Â font-weight: 900;
}
.small-btn.gray{
Â Â background: rgba(120,120,128,.25);
Â Â color: var(--text);
Â Â border: 1px solid var(--stroke);
}
/* è¨ˆæ¸¬ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ç”¨ */
.small-btn.active{
Â Â background: var(--measure) !important;
Â Â color: #fff !important;
Â Â border: none !important;
}
.small-btn:disabled{ opacity: .4; transform: none !important; cursor: default; }
Â 
/* ===== Summary ===== */
.summary{
Â Â margin: 0 12px 12px;
Â Â border-radius: 999px;
Â Â background: var(--card);
Â Â border: 1px solid var(--stroke);
Â Â box-shadow: var(--shadow);
Â Â backdrop-filter: blur(16px);
Â Â -webkit-backdrop-filter: blur(16px);
Â 
Â Â padding: 10px 14px;
Â Â display:flex;
Â Â justify-content: space-around;
Â Â align-items:center;
Â 
Â Â font-size: 14px;
Â Â font-weight: 900;
}
.summary b{ color: var(--accent); }
Â 
/* ===== Canvas ===== */
#canvas-container{
Â Â flex: 1;
Â Â position: relative;
Â Â margin: 0 12px 12px;
Â Â border-radius: 24px;
Â Â overflow: hidden;
Â Â border: 1px solid var(--stroke);
Â Â box-shadow: var(--shadow);
Â Â background: #fff;
Â Â touch-action: none;
Â 
Â Â margin-bottom: 96px;
}
canvas{ display:block; }
Â 
/* ===== Bottom Bar ===== */
.bottom-bar{
Â Â position: fixed;
Â Â left: 12px; right: 12px;
Â Â bottom: calc(12px + env(safe-area-inset-bottom));
Â Â display: grid;
Â Â grid-template-columns: repeat(5, 1fr);
Â Â gap: 10px;
Â Â padding: 10px;
Â Â border-radius: 24px;
Â Â background: var(--card);
Â Â border: 1px solid var(--stroke);
Â Â box-shadow: var(--shadow);
Â Â backdrop-filter: blur(16px);
Â Â -webkit-backdrop-filter: blur(16px);
Â Â z-index: 60;
}
Â 
.pill{
Â Â height: 48px;
Â Â border-radius: 18px;
Â Â background: rgba(120,120,128,.16);
Â Â color: var(--text);
Â Â box-shadow: none;
Â Â font-weight: 900;
Â Â font-size: 13px;
Â Â letter-spacing: .2px;
Â 
Â Â display:flex;
Â Â align-items:center;
Â Â justify-content:center;
Â Â flex-direction: column;
Â Â gap: 2px;
Â Â padding: 6px 0;
}
.pill::after{
Â Â content: attr(data-sub);
Â Â font-size: 10px;
Â Â font-weight: 800;
Â Â color: var(--muted);
Â Â letter-spacing: .1px;
}
.pill.primary{ background: var(--accent); color:#fff; }
.pill.primary::after{ color: rgba(255,255,255,.85); }
.pill.danger{
Â Â background: rgba(255,59,48,.14);
Â Â color: #ff3b30;
}
.pill:disabled{
Â Â opacity: .35;
Â Â filter: grayscale(1);
Â Â transform: none !important;
Â Â cursor: default;
}
Â 
/* ===== Modals ===== */
.modal-overlay{
Â Â display: none;
Â Â position: fixed;
Â Â inset: 0;
Â Â background: rgba(0,0,0,0.6);
Â Â z-index: 1000;
Â Â align-items: center;
Â Â justify-content: center;
}
.modal{
Â Â background: #fff;
Â Â padding: 25px;
Â Â border-radius: 20px;
Â Â width: 85%;
Â Â max-width: 360px;
Â Â text-align: center;
Â Â box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}
.modal input{
Â Â width: 100%;
Â Â padding: 12px;
Â Â margin: 15px 0;
Â Â border: 1px solid #ddd;
Â Â border-radius: 10px;
Â Â font-size: 14px;
Â Â box-sizing: border-box;
}
#helpModal .modal{
Â Â max-width: 420px;
Â Â text-align: left;
Â Â max-height: 80vh;
Â Â overflow-y: auto;
}
#helpModal ul{ padding-left: 20px; font-size: 13px; line-height: 1.6; }
#helpModal h3{ text-align: center; margin-top: 0; }
Â 
.modal.sheet{ width: 92%; max-width: 420px; text-align: left; border-radius: 22px; }
Â 
#labelInput{
Â Â width: 100%;
Â Â padding: 12px 12px;
Â Â border: 1px solid #ddd;
Â Â border-radius: 14px;
Â Â font-size: 16px;
Â Â font-weight: 800;
Â Â outline: none;
}
Â 
.chip-grid{
Â Â display: grid;
Â Â grid-template-columns: repeat(4, 1fr);
Â Â gap: 8px;
Â Â margin-top: 12px;
}
.name-chip{
Â Â height: 38px;
Â Â border-radius: 14px;
Â Â border: 1px solid var(--stroke);
Â Â background: rgba(120,120,128,.14);
Â Â color: var(--text);
Â Â font-weight: 900;
Â Â font-size: 13px;
Â Â letter-spacing: .2px;
Â Â padding: 0 8px;
Â Â width: 100%;
Â Â justify-content: center;
Â Â box-shadow: none;
Â Â gap: 8px;
Â Â display:flex;
}
.name-chip .dot{
Â Â width: 12px;
Â Â height: 12px;
Â Â border-radius: 999px;
Â Â border: 1px solid rgba(0,0,0,.08);
}
.name-chip:active{ transform: scale(.98); opacity: .9; }
Â 
.menu-list{
Â Â display:flex;
Â Â flex-direction: column;
Â Â gap: 10px;
Â Â margin-top: 14px;
}
.menu-btn{
Â Â height: 42px;
Â Â border-radius: 16px;
Â Â border: 1px solid var(--stroke);
Â Â background: rgba(120,120,128,.14);
Â Â color: var(--text);
Â Â font-weight: 900;
Â Â justify-content: center;
}
.menu-btn.danger{
Â Â background: rgba(255,59,48,.14);
Â Â color: #ff3b30;
}
Â 
/* ===== Preset manager (A+B+D) ===== */
.preset-list{ display:flex; flex-direction:column; gap:10px; margin-top: 10px; }
.preset-row{
Â Â display:grid;
Â Â grid-template-columns: 1fr 54px 54px;
Â Â gap: 8px;
Â Â align-items:center;
}
.preset-row input[type="text"]{
Â Â margin: 0;
Â Â padding: 10px 10px;
Â Â border-radius: 14px;
Â Â border: 1px solid #ddd;
Â Â font-weight: 800;
}
.preset-row input[type="color"]{
Â Â width: 54px;
Â Â height: 42px;
Â Â border-radius: 14px;
Â Â padding: 0;
Â Â border: 1px solid var(--stroke);
Â Â background: transparent;
}
.preset-del{
Â Â height: 42px;
Â Â border-radius: 14px;
Â Â background: rgba(255,59,48,.14);
Â Â color:#ff3b30;
Â Â border: 1px solid rgba(255,59,48,.25);
Â Â font-weight: 900;
}
Â 
/* A: preset modal = flex column, list scroll, footer sticky */
#presetModal .modal.sheet{
Â Â max-height: calc(86vh - env(safe-area-inset-bottom));
Â Â display: flex;
Â Â flex-direction: column;
}
#presetList{
Â Â overflow: auto;
Â Â -webkit-overflow-scrolling: touch;
Â Â flex: 1;
Â Â padding-right: 4px;
}
.preset-footer{
Â Â position: sticky;
Â Â bottom: 0;
Â Â padding-top: 10px;
Â Â background: inherit;
}
Â 
/* B: search input */
#presetSearch{
Â Â width: 100%;
Â Â padding: 10px 12px;
Â Â border-radius: 14px;
Â Â border: 1px solid #ddd;
Â Â font-weight: 800;
Â Â outline: none;
}
Â 
/* ===== Layout list (ä¿å­˜ä¸€è¦§: æ¯”è¼ƒç”¨) ===== */
.layout-list{
Â Â overflow:auto;
Â Â -webkit-overflow-scrolling: touch;
Â Â flex: 1;
Â Â padding-right: 4px;
Â Â margin-top: 10px;
}
.layout-row{
Â Â display: grid;
Â Â grid-template-columns: 1fr 74px 74px 44px;
Â Â gap: 8px;
Â Â align-items: center;
Â Â margin-bottom: 10px;
}
.layout-row input[type="text"]{
Â Â margin: 0;
Â Â padding: 10px 10px;
Â Â border-radius: 14px;
Â Â border: 1px solid #ddd;
Â Â font-weight: 800;
}
.layout-btn{
Â Â height: 42px;
Â Â border-radius: 14px;
Â Â border: 1px solid var(--stroke);
Â Â background: rgba(120,120,128,.14);
Â Â color: var(--text);
Â Â font-weight: 900;
Â Â justify-content: center;
}
.layout-del{
Â Â height: 42px;
Â Â border-radius: 14px;
Â Â background: rgba(255,59,48,.14);
Â Â color:#ff3b30;
Â Â border: 1px solid rgba(255,59,48,.25);
Â Â font-weight: 900;
Â Â padding: 0;
}
</style>
</head>
Â 
<body>
<div class="ver-label">ver 6.12<br>by yuchiğŸ”</div>
Â 
<div class="toolbar">
Â Â <div class="top-left">
Â Â Â Â <button class="btn-help" id="openHelpBtn" aria-label="ãƒ˜ãƒ«ãƒ—">ï¼Ÿ</button>
Â Â Â Â <div class="top-title" id="topTitle">MORI</div>
Â Â </div>
Â Â <div class="top-right">
Â Â Â Â <button class="btn-primary" id="saveBtn">å…±æœ‰URL</button>
Â Â Â Â <div class="color-circle" title="é¸æŠä¸­ãƒ‘ãƒ¼ãƒ„ã®è‰²">
Â Â Â Â Â Â <input type="color" id="colorPicker" value="#ffffff">
Â Â Â Â </div>
Â Â </div>
</div>
Â 
<div class="config-bar">
Â Â <div class="chip-group">
Â Â Â Â <label class="chip"><input type="checkbox" id="showJou" checked="">ç•³</label>
Â Â Â Â <label class="chip"><input type="checkbox" id="showTsubo" checked="">åª</label>
Â Â Â Â <label class="chip"><input type="checkbox" id="showM2" checked="">mÂ²</label>
Â Â Â Â <label class="chip" style="background:rgba(120,120,128,.20);"><input type="checkbox" id="useHalfGrid">åŠã¾ã™</label>
Â Â </div>
Â 
Â Â <div class="right-actions">
Â Â Â Â 
Â Â Â Â <div class="segment" role="tablist" aria-label="è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰">
Â Â Â Â Â Â <button class="seg-btn" id="segEdit" type="button">ç·¨é›†</button>
Â Â Â Â Â Â <button class="seg-btn active" id="segMerge" type="button">çµåˆ</button>
Â Â Â Â </div>
Â 
Â Â Â Â <button id="measureBtn" class="small-btn gray" type="button">è¨ˆæ¸¬</button>
Â 
Â Â Â Â <button id="undoBtn" class="small-btn gray" type="button">æˆ»ã‚‹</button>
Â Â Â Â <button id="redoBtn" class="small-btn gray" type="button" disabled="">é€²ã‚€</button>
Â 
Â Â Â Â <button id="fitBtn" class="small-btn" type="button">å¤–æ ã«ãƒ•ã‚£ãƒƒãƒˆ</button>
Â Â Â Â <button id="centerBtn" class="small-btn" type="button">è¡¨ç¤ºãƒªã‚»ãƒƒãƒˆ</button>
Â Â </div>
</div>
Â 
<div class="summary">
Â Â <span>å»¶åºŠ: <b id="totalTsubo">7.00</b> åª</span>
Â Â <span><b id="totalJou">14.0</b> ç•³</span>
Â Â <span id="m2Wrap"><b id="totalM2">23.1</b> mÂ²</span>
</div>
Â 
<div id="canvas-container"><canvas id="canvas" width="364" height="226"></canvas></div>
Â 
<div class="bottom-bar" id="bottomBar">
Â Â <button class="pill" id="addFrameBtn2" data-sub="æ ã‚’è¿½åŠ ">å¤–æ </button>
Â Â <button class="pill primary" id="addGenericRoomBtn2" data-sub="ãƒ—ãƒªã‚»ãƒƒãƒˆé¸æŠ">éƒ¨å±‹</button>
Â Â <button class="pill" id="addWallBtn2" data-sub="ç·šåˆ†å£ã‚’è¿½åŠ ">å£</button>
Â Â <button class="pill" id="copyBtn2" data-sub="é¸æŠã‚’è¤‡è£½" disabled="">è¤‡è£½</button>
Â Â 
Â Â <button class="pill danger" id="resetBtn2" data-sub="é¸æŠ/å…¨æ¶ˆå»">å‰Šé™¤</button>
</div>
Â 
<div id="saveModal" class="modal-overlay" style="display: none;">
Â Â <div class="modal">
Â Â Â Â <h3>ä¿å­˜ãƒ»å…±æœ‰</h3>
Â Â Â Â Â 
Â Â Â Â <div style="text-align:left; font-size:12px; font-weight:bold; color:#666; margin-bottom:4px;">é–“å–ã‚Šå</div>
Â Â Â Â <input type="text" id="layoutTitleInput" value="MORIYASUğŸ " maxlength="20" style="margin-top:0; font-weight:bold;">
Â 
Â Â Â Â <div style="font-size:12px;color:#666;margin-top:10px;">å…±æœ‰URLï¼ˆç™ºè¡Œå¾Œã¯è‡ªå‹•ä¿å­˜ï¼‰</div>
Â Â Â Â <input type="text" id="shareUrlInput" readonly="" onclick="this.select()">
Â Â Â Â Â 
Â Â Â Â <div style="display:flex; gap:10px;">
Â Â Â Â Â Â <button style="flex:1; background:var(--accent);" id="copyUrlBtn">ã‚³ãƒ”ãƒ¼</button>
Â Â Â Â Â Â <button style="flex:1; background:rgba(120,120,128,.45); color:#fff;" id="closeSaveModalBtn">é–‰ã˜ã‚‹</button>
Â Â Â Â </div>
Â 
Â Â Â Â <div style="display:flex; gap:10px; margin-top:10px;">
Â Â Â Â Â Â <button style="flex:1; background:rgba(120,120,128,.18); color:#111; border:1px solid rgba(60,60,67,.18);" id="openLayoutsBtn">ä¿å­˜ä¸€è¦§</button>
Â Â Â Â Â Â <button style="flex:1; background:rgba(120,120,128,.18); color:#111; border:1px solid rgba(60,60,67,.18);" id="saveAsBtn">åˆ¥åã§ä¿å­˜</button>
Â Â Â Â </div>
Â Â </div>
</div>
Â 
<div id="layoutsModal" class="modal-overlay">
Â Â <div class="modal sheet" style="max-height:calc(86vh - env(safe-area-inset-bottom)); display:flex; flex-direction:column;">
Â Â Â Â <h3 style="margin:0 0 6px;">ä¿å­˜ä¸€è¦§</h3>
Â Â Â Â <div style="font-size:12px;color:#666;margin-bottom:6px;">åå‰ã‚’ç·¨é›†ã§ãã¾ã™ / ã€Œæ–°è¦ã‚¿ãƒ–ã€ã§æ¯”è¼ƒãŒãƒ©ã‚¯</div>
Â 
Â Â Â Â <div class="layout-list" id="layoutList"></div>
Â 
Â Â Â Â <div class="preset-footer">
Â Â Â Â Â Â <div style="display:flex; gap:10px; margin-top:10px;">
Â Â Â Â Â Â Â Â <button class="small-btn gray" id="layoutsCloseBtn" type="button" style="height:42px; flex:1;">é–‰ã˜ã‚‹</button>
Â Â Â Â Â Â </div>
Â Â Â Â </div>
Â Â </div>
</div>
Â 
<div id="helpModal" class="modal-overlay">
Â Â <div class="modal">
Â Â Â Â <h3>ğŸ  æ“ä½œãƒãƒ‹ãƒ¥ã‚¢ãƒ«</h3>
Â Â Â Â <ul>
Â Â Â Â Â Â <li><b>ç§»å‹•:</b> ãƒ‘ãƒ¼ãƒ„ã®â€œä¸­å¤®ãƒãƒ³ãƒ‰ãƒ«â€ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼ˆèª¤ãƒªã‚µã‚¤ã‚ºé˜²æ­¢ï¼‰ã€‚</li>
Â Â Â Â Â Â <li><b>ã‚µã‚¤ã‚º:</b> å³ä¸‹ã®ä¸¸ã„ãƒãƒ³ãƒ‰ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã€‚</li>
Â Â Â Â Â Â <li><b>é¸æŠè§£é™¤:</b> ä½•ã‚‚ãªã„æ‰€ã‚’è»½ãã‚¿ãƒƒãƒ—ã€‚</li>
Â Â Â Â Â Â <li><b>é•·æŠ¼ã—:</b> æŒ‡ã‚’å‹•ã‹ã•ãšæŠ¼ã—ç¶šã‘ã‚‹ã¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€‚</li>
Â Â Â Â Â Â <li><b>è¨ˆæ¸¬:</b> ã€Œè¨ˆæ¸¬ã€ãƒœã‚¿ãƒ³ã§ãƒ¢ãƒ¼ãƒ‰ONã€2ç‚¹ã‚’ã‚¿ãƒƒãƒ—ã—ã¦è·é›¢ã‚’è¡¨ç¤ºã€‚</li>
Â Â Â Â Â Â <li><b>å£(ç·š):</b> ç«¯ç‚¹ãƒ‰ãƒ©ãƒƒã‚°ã§é•·ã•ã€ç·šãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹•ã€‚</li>
Â Â Â Â Â Â <li><b>ãƒ”ãƒ³ãƒ:</b> 2æœ¬æŒ‡ã§ã‚ºãƒ¼ãƒ ï¼†ç§»å‹•ã€‚</li>
Â Â Â Â Â Â <li><b>åå‰ç·¨é›†:</b> 2å›ã‚¿ãƒƒãƒ—ï¼ˆç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®ã¿ï¼‰ã€‚</li>
Â Â Â Â Â Â <li><b>ä¿å­˜:</b> å…±æœ‰URLã‚’ç™ºè¡Œã—ã¦ç¶šãã‚’ç·¨é›†å¯èƒ½ï¼ˆç™ºè¡Œå¾Œã¯è‡ªå‹•ä¸Šæ›¸ãä¿å­˜ï¼‰ã€‚</li>
Â Â Â Â </ul>
Â Â Â Â <p style="font-size:11px; color:#666; text-align:center;">ï¼ˆç”»é¢ã‚’ã‚¿ãƒƒãƒ—ã—ã¦é–‰ã˜ã‚‹ï¼‰</p>
Â Â </div>
</div>
Â 
<div id="labelModal" class="modal-overlay" style="display: none;">
Â Â <div class="modal sheet">
Â Â Â Â <h3 id="labelModalTitle" style="margin:0 0 6px;">éƒ¨å±‹ã‚’è¿½åŠ </h3>
Â Â Â Â <div id="labelModalSub" style="font-size:12px;color:#666;margin-bottom:10px;">ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ã‚¿ãƒƒãƒ—ã§å³è¿½åŠ  / å…¥åŠ›ã—ã¦OKã§ã‚‚è¿½åŠ </div>
Â 
Â Â Â Â <input type="text" id="labelInput" placeholder="éƒ¨å±‹åï¼ˆå…¥åŠ›è¿½åŠ ï¼‰" maxlength="12">
Â 
Â Â Â Â <div style="display:flex; gap:10px; margin:12px 0 6px;">
Â Â Â Â Â Â <button class="small-btn gray" id="openPresetBtn" type="button" style="height:36px;">ãƒ—ãƒªã‚»ãƒƒãƒˆç·¨é›†</button>
Â Â Â Â Â Â <div id="addHint" style="font-size: 12px; color: rgb(102, 102, 102); align-self: center; display: block;">â€»ãƒãƒƒãƒ—ã¯å³è¿½åŠ </div>
Â Â Â Â </div>
Â 
Â Â Â Â <div class="chip-grid" id="labelChips"><button type="button" class="name-chip"><span class="dot" style="background:#74a7ff"></span><span>LDK</span></button><button type="button" class="name-chip"><span class="dot" style="background:#E3F2FD"></span><span>æ´‹å®¤</span></button><button type="button" class="name-chip"><span class="dot" style="background:#E8F5E9"></span><span>å¯å®¤</span></button><button type="button" class="name-chip"><span class="dot" style="background:#ECEFF1"></span><span>åœŸé–“</span></button><button type="button" class="name-chip"><span class="dot" style="background:#F3E5F5"></span><span>åç´</span></button><button type="button" class="name-chip"><span class="dot" style="background:#E0F7FA"></span><span>æ´—é¢</span></button><button type="button" class="name-chip"><span class="dot" style="background:#FFFDE7"></span><span>ãƒˆã‚¤ãƒ¬</span></button><button type="button" class="name-chip"><span class="dot" style="background:#FBE9E7"></span><span>ç„é–¢</span></button><button type="button" class="name-chip"><span class="dot" style="background:#FFF3E0"></span><span>éƒ¨å±‹</span></button><button type="button" class="name-chip"><span class="dot" style="background:#FFF3E0"></span><span>éƒ¨å±‹</span></button><button type="button" class="name-chip"><span class="dot" style="background:#FFF3E0"></span><span>éƒ¨å±‹</span></button><button type="button" class="name-chip"><span class="dot" style="background:#FFF3E0"></span><span>éƒ¨å±‹</span></button><button type="button" class="name-chip"><span class="dot" style="background:#FFF3E0"></span><span>éƒ¨å±‹</span></button><button type="button" class="name-chip"><span class="dot" style="background:#FFF3E0"></span><span>éƒ¨å±‹</span></button></div>
Â 
Â Â Â Â <div style="display:flex; gap:10px; margin-top:14px;">
Â Â Â Â Â Â <button style="flex:1; background:rgba(120,120,128,.45); color:#fff;" id="labelCancelBtn" type="button">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
Â Â Â Â Â Â <button style="flex:1; background:var(--accent);" id="labelOkBtn" type="button">OK</button>
Â Â Â Â </div>
Â Â </div>
</div>
Â 
<div id="menuModal" class="modal-overlay">
Â Â <div class="modal sheet">
Â Â Â Â <h3 style="margin:0 0 6px;">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h3>
Â Â Â Â <div id="menuTitle" style="font-size:12px;color:#666;margin-bottom:8px;">é¸æŠä¸­</div>
Â 
Â Â Â Â <div class="menu-list">
Â Â Â Â Â Â <button class="menu-btn" id="menuEditBtn" type="button">åå‰å¤‰æ›´</button>
Â Â Â Â Â Â <button class="menu-btn" id="menuDupBtn" type="button">è¤‡è£½</button>
Â Â Â Â Â Â <button class="menu-btn danger" id="menuDelBtn" type="button">å‰Šé™¤</button>
Â Â Â Â Â Â <button class="menu-btn" id="menuFrontBtn" type="button">æœ€å‰é¢</button>
Â Â Â Â Â Â <button class="menu-btn" id="menuBackBtn" type="button">æœ€èƒŒé¢</button>
Â Â Â Â Â Â <button class="menu-btn" id="menuLockBtn" type="button">ãƒ­ãƒƒã‚¯/è§£é™¤</button>
Â Â Â Â </div>
Â 
Â Â Â Â <div style="display:flex; gap:10px; margin-top:14px;">
Â Â Â Â Â Â <button style="flex:1; background:rgba(120,120,128,.45); color:#fff;" id="menuCloseBtn" type="button">é–‰ã˜ã‚‹</button>
Â Â Â Â </div>
Â Â </div>
</div>
Â 
<div id="presetModal" class="modal-overlay" style="display: none;">
Â Â <div class="modal sheet">
Â Â Â Â <h3 style="margin:0 0 6px;">ãƒ—ãƒªã‚»ãƒƒãƒˆç·¨é›†</h3>
Â Â Â Â <div style="font-size:12px;color:#666;margin-bottom:8px;">éƒ¨å±‹åã¨è‰²ã‚’è¿½åŠ /å¤‰æ›´ã§ãã¾ã™</div>
Â 
Â Â Â Â <input id="presetSearch" type="text" placeholder="æ¤œç´¢ï¼ˆä¾‹ï¼šLDKï¼‰">
Â 
Â Â Â Â <div class="preset-list" id="presetList"><div class="preset-row">
Â Â Â Â Â Â <input type="text" value="LDK" maxlength="12" data-idx="0" data-k="name">
Â Â Â Â Â Â <input type="color" value="#74a7ff" data-idx="0" data-k="color">
Â Â Â Â Â Â <button class="preset-del" type="button" data-idx="0">å‰Šé™¤</button>
Â Â Â Â </div><div class="preset-row">
Â Â Â Â Â Â <input type="text" value="æ´‹å®¤" maxlength="12" data-idx="1" data-k="name">
Â Â Â Â Â Â <input type="color" value="#E3F2FD" data-idx="1" data-k="color">
Â Â Â Â Â Â <button class="preset-del" type="button" data-idx="1">å‰Šé™¤</button>
Â Â Â Â </div><div class="preset-row">
Â Â Â Â Â Â <input type="text" value="å¯å®¤" maxlength="12" data-idx="2" data-k="name">
Â Â Â Â Â Â <input type="color" value="#E8F5E9" data-idx="2" data-k="color">
Â Â Â Â Â Â <button class="preset-del" type="button" data-idx="2">å‰Šé™¤</button>
Â Â Â Â </div><div class="preset-row">
Â Â Â Â Â Â <input type="text" value="åœŸé–“" maxlength="12" data-idx="3" data-k="name">
Â Â Â Â Â Â <input type="color" value="#ECEFF1" data-idx="3" data-k="color">
Â Â Â Â Â Â <button class="preset-del" type="button" data-idx="3">å‰Šé™¤</button>
Â Â Â Â </div><div class="preset-row">
Â Â Â Â Â Â <input type="text" value="åç´" maxlength="12" data-idx="4" data-k="name">
Â Â Â Â Â Â <input type="color" value="#F3E5F5" data-idx="4" data-k="color">
Â Â Â Â Â Â <button class="preset-del" type="button" data-idx="4">å‰Šé™¤</button>
Â Â Â Â </div><div class="preset-row">
Â Â Â Â Â Â <input type="text" value="æ´—é¢" maxlength="12" data-idx="5" data-k="name">
Â Â Â Â Â Â <input type="color" value="#E0F7FA" data-idx="5" data-k="color">
Â Â Â Â Â Â <button class="preset-del" type="button" data-idx="5">å‰Šé™¤</button>
Â Â Â Â </div><div class="preset-row">
Â Â Â Â Â Â <input type="text" value="ãƒˆã‚¤ãƒ¬" maxlength="12" data-idx="6" data-k="name">
Â Â Â Â Â Â <input type="color" value="#FFFDE7" data-idx="6" data-k="color">
Â Â Â Â Â Â <button class="preset-del" type="button" data-idx="6">å‰Šé™¤</button>
Â Â Â Â </div><div class="preset-row">
Â Â Â Â Â Â <input type="text" value="ç„é–¢" maxlength="12" data-idx="7" data-k="name">
Â Â Â Â Â Â <input type="color" value="#FBE9E7" data-idx="7" data-k="color">
Â Â Â Â Â Â <button class="preset-del" type="button" data-idx="7">å‰Šé™¤</button>
Â Â Â Â </div><div class="preset-row">
Â Â Â Â Â Â <input type="text" value="éƒ¨å±‹" maxlength="12" data-idx="8" data-k="name">
Â Â Â Â Â Â <input type="color" value="#FFF3E0" data-idx="8" data-k="color">
Â Â Â Â Â Â <button class="preset-del" type="button" data-idx="8">å‰Šé™¤</button>
Â Â Â Â </div><div class="preset-row">
Â Â Â Â Â Â <input type="text" value="éƒ¨å±‹" maxlength="12" data-idx="9" data-k="name">
Â Â Â Â Â Â <input type="color" value="#FFF3E0" data-idx="9" data-k="color">
Â Â Â Â Â Â <button class="preset-del" type="button" data-idx="9">å‰Šé™¤</button>
Â Â Â Â </div><div class="preset-row">
Â Â Â Â Â Â <input type="text" value="éƒ¨å±‹" maxlength="12" data-idx="10" data-k="name">
Â Â Â Â Â Â <input type="color" value="#FFF3E0" data-idx="10" data-k="color">
Â Â Â Â Â Â <button class="preset-del" type="button" data-idx="10">å‰Šé™¤</button>
Â Â Â Â </div><div class="preset-row">
Â Â Â Â Â Â <input type="text" value="éƒ¨å±‹" maxlength="12" data-idx="11" data-k="name">
Â Â Â Â Â Â <input type="color" value="#FFF3E0" data-idx="11" data-k="color">
Â Â Â Â Â Â <button class="preset-del" type="button" data-idx="11">å‰Šé™¤</button>
Â Â Â Â </div><div class="preset-row">
Â Â Â Â Â Â <input type="text" value="éƒ¨å±‹" maxlength="12" data-idx="12" data-k="name">
Â Â Â Â Â Â <input type="color" value="#FFF3E0" data-idx="12" data-k="color">
Â Â Â Â Â Â <button class="preset-del" type="button" data-idx="12">å‰Šé™¤</button>
Â Â Â Â </div><div class="preset-row">
Â Â Â Â Â Â <input type="text" value="éƒ¨å±‹" maxlength="12" data-idx="13" data-k="name">
Â Â Â Â Â Â <input type="color" value="#FFF3E0" data-idx="13" data-k="color">
Â Â Â Â Â Â <button class="preset-del" type="button" data-idx="13">å‰Šé™¤</button>
Â Â Â Â </div></div>
Â 
Â Â Â Â <div class="preset-footer">
Â Â Â Â Â Â <div style="display:flex; gap:10px; margin-top:12px;">
Â Â Â Â Â Â Â Â <button class="small-btn gray" id="presetAddBtn" type="button" style="height:42px;">ï¼‹è¿½åŠ </button>
Â Â Â Â Â Â Â Â <button class="small-btn" id="presetSaveBtn" type="button" style="height:42px;">ä¿å­˜</button>
Â Â Â Â Â Â </div>
Â 
Â Â Â Â Â Â <div style="display:flex; gap:10px; margin-top:10px;">
Â Â Â Â Â Â Â Â <button style="flex:1; background:rgba(120,120,128,.45); color:#fff;" id="presetCloseBtn" type="button">é–‰ã˜ã‚‹</button>
Â Â Â Â Â Â </div>
Â Â Â Â </div>
Â Â </div>
</div>
Â 
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDoc, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
Â 
const firebaseConfig = {
Â Â apiKey: "AIzaSyBH4zoH5ZnfPcZmmXNvfeGOJz9__KkSMrg",
Â Â authDomain: "test-55430.firebaseapp.com",
Â Â projectId: "test-55430",
Â Â storageBucket: "test-55430.firebasestorage.app",
Â Â messagingSenderId: "742726212885",
Â Â appId: "1:742726212885:web:597a48fc1ce0cb7f529d1c",
Â Â measurementId: "G-PW24JY2LBP"
};
Â 
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
Â 
const el = (id) => document.getElementById(id);
Â 
const canvas = el('canvas');
const ctx = canvas.getContext('2d');
const container = el('canvas-container');
Â 
const GRID_SIZE = 32;
const HISTORY_MAX = 50;
Â 
const PRESET_KEY = "floorplan_presets_v1";
/* ä¿å­˜ä¸€è¦§ï¼ˆè¤‡æ•°é–“å–ã‚Šï¼‰ */
const LAYOUTS_KEY = "floorplan_saved_layouts_v1";
Â 
const WALL_DEFAULT_THICK = 12;
const WALL_HANDLE_R = 18;Â Â Â Â Â  // screen px
const WALL_HIT_PAD = 12;
// screen px
const SNAP_ANGLE_DEG = 15;
Â 
const AUTOSAVE_DELAY = 1500;
Â 
// â˜… mÂ²æ›ç®—ï¼ˆåªâ†’mÂ²ï¼‰
const TSUBO_TO_M2 = 3.305785;
/* â˜…ç§»å‹•ãƒãƒ³ãƒ‰ãƒ« */
const MOVE_HANDLE_R = 14;Â Â Â Â Â  // screen px
const MOVE_HANDLE_HIT = 22;Â Â Â  // screen px
Â 
/* å°éƒ¨å±‹åˆ¤å®šï¼ˆãƒã‚¹æ•°ï¼‰ */
const SMALL_ROOM_MAX_MASU = 4;
let items = [];
let selectedItem = null;
Â 
let isMerged = false;
let camera = { x: 0, y: 0 };Â Â  // screen px
let scale = 1.0;Â Â Â Â Â Â Â Â Â Â Â Â Â Â  // zoom
Â 
let lastTapTime = 0;
let layoutId = null;
Â 
// â˜…ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå
let currentTitle = "MORIYASUğŸ ";
Â 
let editingItem = null;
let menuItem = null;
Â 
// â˜…è¿½åŠ /ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
let labelModalMode = "edit";Â  // "edit" | "add"
let addPendingColor = "#FFF3E0"; // å…¥åŠ›è¿½åŠ æ™‚ã®è‰²ï¼ˆç›´å‰é¸æŠã‚’ä¿æŒï¼‰
Â 
// â˜…è¨ˆæ¸¬ãƒ¢ãƒ¼ãƒ‰
let isMeasureMode = false;
let measurePoints = []; // {x,y}
Â 
// Undo/Redo
let undoStack = [];
let redoStack = [];
let gestureSnapshot = null;
// Auto-save
let autosaveTimer = null;
Â 
// Presets
let presets = [];
let presetSearchQuery = "";
Â 
// Touch states
let longPressTimer = null;
let pressStart = null;Â Â Â Â Â Â Â Â Â Â  // {clientX, clientY}
let pressStartWorld = null;Â Â Â Â Â  // {x,y}
let pendingItem = null;
// hit item (rect or wallLine)
let pendingWallHandle = null;Â Â Â  // "p1"|"p2"|null
let pendingAction = null;Â Â Â Â Â Â Â  // "moveRect"|"resizeRect"|"moveWall"|"p1"|"p2"|"pan"|null
let dragActive = false;
let rectDragOffset = null;Â Â Â Â Â Â  // {dx,dy} in world for rect move
let wallMoveOffset = null;
// {dx,dy} in world for wall move
let emptyTapCandidate = false;Â Â  // â˜…ä½•ã‚‚ãªã„æ‰€ã‚¿ãƒƒãƒ—ã§é¸æŠè§£é™¤
Â 
// Pinch
let pinchActive = false;
let pinchStartDist = 0;
let pinchStartScale = 1;
let pinchWorldMid = null;
Â 
function uid(){
Â Â return Math.random().toString(36).slice(2, 10) + Date.now().toString(36).slice(-4);
}
Â 
function ensureIds(){
Â Â items.forEach(it => {
Â Â Â Â if(!it.id) it.id = uid();
Â Â Â Â if(typeof it.locked !== "boolean") it.locked = false;
Â Â Â Â if(it.type === 'wallLine'){
Â Â Â Â Â Â if(typeof it.thick !== "number") it.thick = WALL_DEFAULT_THICK;
Â Â Â Â Â Â if(!it.color) it.color = "#616161";
Â Â Â Â Â Â if(!it.label) it.label = "å£";
Â Â Â Â }
Â Â });
}
Â 
function normalizeZ(){
Â Â const frames = items.filter(i => i.type === 'frame');
Â Â const others = items.filter(i => i.type !== 'frame');
Â Â items = [...frames, ...others];
}
Â 
function getSnapStep(){
Â Â return el('useHalfGrid').checked ? 16 : 32;
}
function getSnapped(val, step){
Â Â return Math.round(val / step) * step;
}
function clamp(v, a, b){ return Math.max(a, Math.min(b, v));
}
Â 
/* ===== coordinate ===== */
function screenToWorld(screenX, screenY){
Â Â const rect = canvas.getBoundingClientRect();
Â Â const cx = canvas.width/2;
Â Â const cy = canvas.height/2;
Â Â const x = (screenX - rect.left - cx - camera.x) / scale;
Â Â const y = (screenY - rect.topÂ  - cy - camera.y) / scale;
Â Â return {x,y};
}
Â 
/* ===== autosave ===== */
async function saveLayoutToFirestore(){
Â Â if(!layoutId) return;
Â Â try{
Â Â Â Â await setDoc(doc(db, "layouts", layoutId), { 
Â Â Â Â Â Â items, 
Â Â Â Â Â Â isMerged, 
Â Â Â Â Â Â title: currentTitle, // â˜…ã‚¿ã‚¤ãƒˆãƒ«ã‚‚ä¿å­˜
Â Â Â Â Â Â updatedAt: new Date() 
Â Â Â Â }, { merge: true });
Â Â }catch(e){
Â Â Â Â console.warn("save failed", e);
Â Â }
}
Â 
function scheduleAutoSave(){
Â Â if(!layoutId) return;
Â Â if(autosaveTimer) clearTimeout(autosaveTimer);
Â Â autosaveTimer = setTimeout(async () => {
Â Â Â Â await saveLayoutToFirestore();
Â Â Â Â touchLayoutMeta(layoutId); // ä¿å­˜ä¸€è¦§ã®updatedæ›´æ–°
Â Â }, AUTOSAVE_DELAY);
}
Â 
/* ===== history ===== */
function snapshot(){
Â Â ensureIds();
Â Â return {
Â Â Â Â items: items.map(i => ({...i})),
Â Â Â Â selectedId: selectedItem?.id || null,
Â Â Â Â isMerged,
Â Â Â Â camera: {...camera},
Â Â Â Â scale,
Â Â Â Â layoutId,
Â Â Â Â title: currentTitle
Â Â };
}
Â 
function restore(s){
Â Â items = (s.items || []).map(i => ({...i}));
Â Â ensureIds();
Â Â normalizeZ();
Â Â isMerged = !!s.isMerged;
Â Â camera = s.camera ? {...s.camera} : {x:0,y:0};
Â Â scale = typeof s.scale === "number" ? s.scale : 1.0;
Â Â layoutId = s.layoutId ?? layoutId;
Â Â currentTitle = s.title || currentTitle; // ã‚¿ã‚¤ãƒˆãƒ«ã‚‚å¾©å…ƒï¼ˆå±¥æ­´ã«ã‚ã‚Œã°ï¼‰
Â Â el('topTitle').innerText = currentTitle;
Â 
Â Â selectedItem = s.selectedId ? items.find(i => i.id === s.selectedId) || null : null;
Â Â updateSegmentUI();
Â Â draw();
}
Â 
function pushHistory(){
Â Â undoStack.push(snapshot());
Â Â if (undoStack.length > HISTORY_MAX) undoStack.shift();
Â Â redoStack = [];
Â Â syncHistoryButtons();
}
Â 
function undo(){
Â Â if (!undoStack.length) return;
Â Â redoStack.push(snapshot());
Â Â restore(undoStack.pop());
Â Â syncHistoryButtons();
Â Â scheduleAutoSave();
}
Â 
function redo(){
Â Â if (!redoStack.length) return;
Â Â undoStack.push(snapshot());
Â Â restore(redoStack.pop());
Â Â syncHistoryButtons();
Â Â scheduleAutoSave();
}
Â 
function syncHistoryButtons(){
Â Â el('undoBtn').disabled = undoStack.length === 0;
Â Â el('redoBtn').disabled = redoStack.length === 0;
}
Â 
/* ===== presets ===== */
function defaultPresets(){
Â Â return [
Â Â Â Â { name: "LDK", color: "#FFF3E0" },
Â Â Â Â { name: "æ´‹å®¤", color: "#E3F2FD" },
Â Â Â Â { name: "å¯å®¤", color: "#E8F5E9" },
Â Â Â Â { name: "åœŸé–“", color: "#ECEFF1" },
Â Â Â Â { name: "åç´", color: "#F3E5F5" },
Â Â Â Â { name: "æ´—é¢", color: "#E0F7FA" },
Â Â Â Â { name: "ãƒˆã‚¤ãƒ¬", color: "#FFFDE7" },
Â Â Â Â { name: "ç„é–¢", color: "#FBE9E7" },
Â Â ];
}
function loadPresets(){
Â Â try{
Â Â Â Â const raw = localStorage.getItem(PRESET_KEY);
Â Â Â Â if(raw){
Â Â Â Â Â Â const arr = JSON.parse(raw);
Â Â Â Â Â Â if(Array.isArray(arr) && arr.length){
Â Â Â Â Â Â Â Â return arr.map(p => ({
Â Â Â Â Â Â Â Â Â Â name: String(p.name||"").trim() || "éƒ¨å±‹",
Â Â Â Â Â Â Â Â Â Â color: String(p.color||"#FFF3E0")
Â Â Â Â Â Â Â Â }));
Â Â Â Â Â Â }
Â Â Â Â }
Â Â }catch(_){}
Â Â return defaultPresets();
}
function savePresets(){
Â Â localStorage.setItem(PRESET_KEY, JSON.stringify(presets));
}
function escapeHtml(s){
Â Â return String(s).replace(/[&<>"']/g, m => ({'&':'&','<':'<','>':'>','"':'"',"'":'''}[m]));
}
Â 
function onPresetPicked(name, color){
Â Â // â˜…è¿½åŠ ãƒ¢ãƒ¼ãƒ‰ï¼šãƒãƒƒãƒ—ã¯å³è¿½åŠ 
Â Â if(labelModalMode === "add"){
Â Â Â Â addPendingColor = color || "#FFF3E0";
Â Â Â Â closeLabelModal();
Â Â Â Â addRect(name, 4, 4, addPendingColor, 'room');
Â Â Â Â return;
Â Â }
Â Â // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼šåå‰ï¼‹è‰²ã‚’é©ç”¨
Â Â el('labelInput').value = name;
Â Â applyLabel(true, color);
}
Â 
function renderPresetChips(){
Â Â const box = el('labelChips');
Â Â box.innerHTML = "";
Â Â presets.forEach(p => {
Â Â Â Â const b = document.createElement("button");
Â Â Â Â b.type = "button";
Â Â Â Â b.className = "name-chip";
Â Â Â Â b.innerHTML = `<span class="dot" style="background:${p.color}"></span><span>${escapeHtml(p.name)}</span>`;
Â Â Â Â b.addEventListener("click", () => onPresetPicked(p.name, p.color));
Â Â Â Â box.appendChild(b);
Â Â });
}
Â 
/* A+B: editor list = scroll + search filter */
function renderPresetEditorList(){
Â Â const list = el('presetList');
Â Â list.innerHTML = "";
Â Â const q = (presetSearchQuery || "").toLowerCase();
Â Â const visible = presets
Â Â Â Â .map((p, idx) => ({...p, idx}))
Â Â Â Â .filter(p => !q || (p.name || "").toLowerCase().includes(q));
Â Â visible.forEach(({name, color, idx}) => {
Â Â Â Â const row = document.createElement("div");
Â Â Â Â row.className = "preset-row";
Â Â Â Â row.innerHTML = `
Â Â Â Â Â Â <input type="text" value="${escapeHtml(name)}" maxlength="12" data-idx="${idx}" data-k="name">
Â Â Â Â Â Â <input type="color" value="${color}" data-idx="${idx}" data-k="color">
Â Â Â Â Â Â <button class="preset-del" type="button" data-idx="${idx}">å‰Šé™¤</button>
Â Â Â Â `;
Â Â Â Â list.appendChild(row);
Â Â });
Â Â list.querySelectorAll('input').forEach(inp => {
Â Â Â Â inp.addEventListener('input', () => {
Â Â Â Â Â Â const i = Number(inp.dataset.idx);
Â Â Â Â Â Â const k = inp.dataset.k;
Â Â Â Â Â Â if(!presets[i]) return;
Â Â Â Â Â Â if(k === 'name') presets[i].name = (inp.value || "").trim().slice(0,12) || "éƒ¨å±‹";
Â Â Â Â Â Â if(k === 'color') presets[i].color = inp.value || "#FFF3E0";
Â Â Â Â });
Â Â });
Â Â list.querySelectorAll('.preset-del').forEach(btn => {
Â Â Â Â btn.addEventListener('click', () => {
Â Â Â Â Â Â const i = Number(btn.dataset.idx);
Â Â Â Â Â Â presets.splice(i, 1);
Â Â Â Â Â Â renderPresetEditorList();
Â Â Â Â });
Â Â });
}
Â 
/* D: focus row into view (keyboard-safe) */
el('presetList').addEventListener('focusin', (e) => {
Â Â const row = e.target.closest?.('.preset-row');
Â Â if(row) row.scrollIntoView({ block: 'center', behavior: 'smooth' });
});
/* ===== layouts list (ä¿å­˜/æ¯”è¼ƒ) ===== */
function loadLayouts(){
Â Â try{
Â Â Â Â const raw = localStorage.getItem(LAYOUTS_KEY);
Â Â Â Â const arr = raw ? JSON.parse(raw) : [];
Â Â Â Â if(Array.isArray(arr)) return arr;
Â Â }catch(_){}
Â Â return [];
}
function saveLayouts(arr){
Â Â localStorage.setItem(LAYOUTS_KEY, JSON.stringify(arr));
}
function formatDate(ts){
Â Â try{
Â Â Â Â const d = new Date(ts);
Â Â Â Â return d.toLocaleString('ja-JP', { month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
Â Â }catch(_){ return ""; }
}
function upsertLayoutMeta(id, patch){
Â Â const list = loadLayouts();
Â Â const idx = list.findIndex(x => x.id === id);
Â Â // â˜…åå‰ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’é©ç”¨
Â Â const title = patch.title || currentTitle || "MORIYASUğŸ ";
Â 
Â Â if(idx >= 0){
Â Â Â Â list[idx] = { ...list[idx], ...patch, title };
Â Â }else{
Â Â Â Â list.unshift({ id, title, updatedAt: patch.updatedAt || Date.now() });
Â Â }
Â Â saveLayouts(list);
}
function touchLayoutMeta(id){
Â Â if(!id) return;
Â Â upsertLayoutMeta(id, { updatedAt: Date.now() });
}
function renderLayoutList(){
Â Â const box = el('layoutList');
Â Â box.innerHTML = "";
Â Â const list = loadLayouts();
Â 
Â Â if(!list.length){
Â Â Â Â box.innerHTML = `<div style="font-size:13px;color:#666;">ã¾ã ä¿å­˜ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆå…±æœ‰URLç™ºè¡Œã§è‡ªå‹•ç™»éŒ²ï¼‰</div>`;
Â Â Â Â return;
Â Â }
Â 
Â Â list.forEach((it) => {
Â Â Â Â const row = document.createElement('div');
Â Â Â Â row.className = 'layout-row';
Â Â Â Â // â˜…IDè¡¨ç¤ºã‚’å‰Šé™¤ã—ã€æ›´æ–°æ—¥æ™‚ã‚’ã‚·ãƒ³ãƒ—ãƒ«ã«å³å¯„ã›
Â Â Â Â row.innerHTML = `
Â Â Â Â Â Â <input type="text" value="${escapeHtml(it.title || "MORIYASUğŸ ")}" maxlength="24" data-id="${it.id}">
Â Â Â Â Â Â <button class="layout-btn" type="button" data-act="open" data-id="${it.id}">é–‹ã</button>
Â Â Â Â Â Â <button class="layout-btn" type="button" data-act="newtab" data-id="${it.id}">æ–°è¦ã‚¿ãƒ–</button>
Â Â Â Â Â Â <button class="layout-del" type="button" data-act="del" data-id="${it.id}">Ã—</button>
Â Â Â Â Â Â <div style="grid-column:1 / -1; font-size:11px; color:#999; margin-top:-4px; text-align:right;">
Â Â Â Â Â Â Â Â ${formatDate(it.updatedAt || Date.now())}
Â Â Â Â Â Â </div>
Â Â Â Â `;
Â Â Â Â box.appendChild(row);
Â Â });
Â Â box.querySelectorAll('input[type="text"]').forEach(inp => {
Â Â Â Â inp.addEventListener('input', () => {
Â Â Â Â Â Â const id = inp.dataset.id;
Â Â Â Â Â Â upsertLayoutMeta(id, { title: (inp.value||"").trim().slice(0,24) || "é–“å–ã‚Š" });
Â Â Â Â });
Â Â });
Â Â box.querySelectorAll('button').forEach(btn => {
Â Â Â Â const act = btn.dataset.act;
Â Â Â Â const id = btn.dataset.id;
Â Â Â Â if(!act || !id) return;
Â 
Â Â Â Â btn.addEventListener('click', () => {
Â Â Â Â Â Â if(act === 'open'){
Â Â Â Â Â Â Â Â const url = `${window.location.origin}${window.location.pathname}?id=${id}`;
Â Â Â Â Â Â Â Â window.location.href = url;
Â Â Â Â Â Â }
Â Â Â Â Â Â if(act === 'newtab'){
Â Â Â Â Â Â Â Â const url = `${window.location.origin}${window.location.pathname}?id=${id}`;
Â Â Â Â Â Â Â Â window.open(url, "_blank");
Â Â Â Â Â Â }
Â Â 
Â Â Â Â Â Â if(act === 'del'){
Â Â Â Â Â Â Â Â const list = loadLayouts().filter(x => x.id !== id);
Â Â Â Â Â Â Â Â saveLayouts(list);
Â Â Â Â Â Â Â Â renderLayoutList();
Â Â Â Â Â Â }
Â Â Â Â });
Â Â });
}
Â 
/* ===== UI helpers ===== */
function resizeCanvas(){
Â Â canvas.width = container.clientWidth;
Â Â canvas.height = container.clientHeight;
Â Â draw();
}
function updateSegmentUI(){
Â Â el('segEdit').classList.toggle('active', !isMerged);
Â Â el('segMerge').classList.toggle('active', isMerged);
}
function setMergedMode(val){
Â Â isMerged = val;
Â Â updateSegmentUI();
Â Â draw();
}
Â 
/* â˜… mÂ²è¡¨ç¤ºON/OFFå¯¾å¿œã®ã‚µãƒãƒªãƒ¼ */
function updateSummary(){
Â Â let tm = 0;
Â Â items.forEach(i => { if(i.type === 'frame') tm += (i.w/GRID_SIZE)*(i.h/GRID_SIZE); });
Â 
Â Â const tsubo = tm/4;
Â Â const jou = tm/2;
Â Â const m2 = tsubo * TSUBO_TO_M2;
Â 
Â Â el('totalTsubo').innerText = tsubo.toFixed(2);
Â Â el('totalJou').innerText = jou.toFixed(1);
Â Â el('totalM2').innerText = m2.toFixed(1);
Â 
Â Â const showM2 = el('showM2')?.checked ?? true;
Â Â const wrap = el('m2Wrap');
Â Â if(wrap) wrap.style.display = showM2 ? "" : "none";
}
Â 
function syncBottomBarState(){
Â Â el('copyBtn2').disabled = !selectedItem;
}
Â 
/* ===== add items ===== */
function addRect(label, w, h, color, type='room'){
Â Â pushHistory();
Â Â const targetX = getSnapped((-camera.x)/scale, GRID_SIZE);
Â Â const targetY = getSnapped((-camera.y)/scale, GRID_SIZE);
Â Â const i = { id: uid(), locked:false, type, x: targetX, y: targetY, w: w*GRID_SIZE, h: h*GRID_SIZE, label, color };
Â Â if(type === 'frame') items.unshift(i); else items.push(i);
Â Â ensureIds();
Â Â normalizeZ();
Â Â selectedItem = i;
Â Â draw();
Â Â scheduleAutoSave();
}
function addWallLine(){
Â Â pushHistory();
Â Â const targetX = getSnapped((-camera.x)/scale, GRID_SIZE);
Â Â const targetY = getSnapped((-camera.y)/scale, GRID_SIZE);
Â Â const len = 4 * GRID_SIZE;
Â Â const wall = {
Â Â Â Â id: uid(),
Â Â Â Â locked:false,
Â Â Â Â type: 'wallLine',
Â Â Â Â label: 'å£',
Â Â Â Â color: '#616161',
Â Â Â Â thick: WALL_DEFAULT_THICK,
Â Â Â Â x1: targetX,
Â Â Â Â y1: targetY,
Â Â Â Â x2: targetX + len,
Â Â Â Â y2: targetY
Â Â };
Â Â items.push(wall);
Â Â ensureIds();
Â Â normalizeZ();
Â Â selectedItem = wall;
Â Â draw();
Â Â scheduleAutoSave();
}
Â 
/* ===== menu actions ===== */
function openMenu(item){
Â Â if(!item) return;
Â Â menuItem = item;
Â Â const lockedText = item.locked ? "ï¼ˆãƒ­ãƒƒã‚¯ï¼‰" : "";
Â Â el('menuTitle').innerText = `${item.label || "ï¼ˆç„¡åï¼‰"} / ${item.type}${lockedText}`;
Â Â el('menuModal').style.display = 'flex';
}
function closeMenu(){
Â Â el('menuModal').style.display = 'none';
Â Â menuItem = null;
}
function duplicateItem(it){
Â Â if(!it) return;
Â Â pushHistory();
Â Â let n;
Â Â if(it.type === 'wallLine'){
Â Â Â Â n = { ...it, id: uid(), x1: it.x1 + GRID_SIZE, y1: it.y1 + GRID_SIZE, x2: it.x2 + GRID_SIZE, y2: it.y2 + GRID_SIZE };
Â Â }else{
Â Â Â Â n = { ...it, id: uid(), x: it.x + GRID_SIZE, y: it.y + GRID_SIZE };
Â Â }
Â Â items.push(n);
Â Â normalizeZ();
Â Â selectedItem = n;
Â Â draw();
Â Â scheduleAutoSave();
}
function deleteItem(it){
Â Â if(!it) return;
Â Â pushHistory();
Â Â items = items.filter(x => x !== it);
Â Â selectedItem = null;
Â Â normalizeZ();
Â Â draw();
Â Â scheduleAutoSave();
}
function bringFront(it){
Â Â if(!it) return;
Â Â pushHistory();
Â Â items = items.filter(x => x !== it);
Â Â items.push(it);
Â Â normalizeZ();
Â Â draw();
Â Â scheduleAutoSave();
}
function bringBack(it){
Â Â if(!it) return;
Â Â pushHistory();
Â Â const frames = items.filter(i => i.type === 'frame');
Â Â const others = items.filter(i => i.type !== 'frame' && i !== it);
Â Â items = [...frames, it, ...others];
Â Â normalizeZ();
Â Â draw();
Â Â scheduleAutoSave();
}
function toggleLock(it){
Â Â if(!it) return;
Â Â pushHistory();
Â Â it.locked = !it.locked;
Â Â draw();
Â Â scheduleAutoSave();
}
Â 
/* ===== label modal (edit/add) ===== */
function openLabelModal(mode){
Â Â labelModalMode = mode; // "add" or "edit"
Â Â el('labelModal').style.display = 'flex';
Â Â if(mode === "add"){
Â Â Â Â el('labelModalTitle').innerText = "éƒ¨å±‹ã‚’è¿½åŠ ";
Â Â Â Â el('labelModalSub').innerText = "ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ã‚¿ãƒƒãƒ—ã§å³è¿½åŠ  / å…¥åŠ›ã—ã¦OKã§ã‚‚è¿½åŠ ";
Â Â Â Â el('addHint').style.display = "block";
Â Â Â Â el('labelInput').placeholder = "éƒ¨å±‹åï¼ˆå…¥åŠ›è¿½åŠ ï¼‰";
Â Â Â Â el('labelInput').value = "";
Â Â }else{
Â Â Â Â el('labelModalTitle').innerText = "éƒ¨å±‹åã‚’å¤‰æ›´";
Â Â Â Â el('labelModalSub').innerText = "å€™è£œã‚’ã‚¿ãƒƒãƒ—ï¼ˆåå‰ï¼‹è‰²ï¼‰ / å…¥åŠ›ã—ã¦OK";
Â Â Â Â el('addHint').style.display = "none";
Â Â Â Â el('labelInput').placeholder = "éƒ¨å±‹å";
Â Â }
Â 
Â Â setTimeout(() => el('labelInput').focus(), 50);
}
Â 
function closeLabelModal(){
Â Â el('labelModal').style.display = 'none';
Â Â labelModalMode = "edit";
Â Â editingItem = null;
}
Â 
function openLabelEditor(item){
Â Â if(!item) return;
Â Â editingItem = item;
Â Â el('labelInput').value = item.label || "";
Â Â openLabelModal("edit");
}
Â 
function applyLabel(applyColor=false, colorValue=null){
Â Â if (!editingItem) return;
Â Â const v = el('labelInput').value.trim();
Â Â if (!v) return;
Â 
Â Â pushHistory();
Â Â editingItem.label = v;
Â Â if(applyColor && colorValue) editingItem.color = colorValue;
Â 
Â Â closeLabelModal();
Â Â draw();
Â Â scheduleAutoSave();
}
Â 
/* ===== wall helpers ===== */
function distPointToSegment(px, py, x1, y1, x2, y2){
Â Â const vx = x2 - x1, vy = y2 - y1;
Â Â const wx = px - x1, wy = py - y1;
Â Â const c1 = vx*wx + vy*wy;
Â Â if (c1 <= 0) return Math.hypot(px - x1, py - y1);
Â Â const c2 = vx*vx + vy*vy;
Â Â if (c2 <= c1) return Math.hypot(px - x2, py - y2);
Â Â const t = c1 / c2;
Â Â const bx = x1 + t*vx;
Â Â const by = y1 + t*vy;
Â Â return Math.hypot(px - bx, py - by);
}
function wallHitTest(worldP, wall){
Â Â const handleRWorld = WALL_HANDLE_R / scale;
Â Â const padWorld = WALL_HIT_PAD / scale;
Â Â const d1 = Math.hypot(worldP.x - wall.x1, worldP.y - wall.y1);
Â Â if(d1 <= handleRWorld) return {hit:true, handle:"p1"};
Â Â const d2 = Math.hypot(worldP.x - wall.x2, worldP.y - wall.y2);
Â Â if(d2 <= handleRWorld) return {hit:true, handle:"p2"};
Â Â const dSeg = distPointToSegment(worldP.x, worldP.y, wall.x1, wall.y1, wall.x2, wall.y2);
Â Â const thickWorld = (wall.thick || WALL_DEFAULT_THICK) / scale;
Â Â if(dSeg <= (thickWorld/2 + padWorld)) return {hit:true, handle:null};
Â 
Â Â return {hit:false, handle:null};
}
function applyRightAngleSnap(wall, movingHandle){
Â Â const ax = (movingHandle === "p1") ? wall.x2 : wall.x1;
Â Â const ay = (movingHandle === "p1") ? wall.y2 : wall.y1;
Â Â const bx = (movingHandle === "p1") ? wall.x1 : wall.x2;
Â Â const by = (movingHandle === "p1") ? wall.y1 : wall.y2;
Â 
Â Â const dx = bx - ax;
Â Â const dy = by - ay;
Â Â const adx = Math.abs(dx), ady = Math.abs(dy);
Â Â if(adx < 1e-6 && ady < 1e-6) return;
Â 
Â Â const tan = Math.tan(SNAP_ANGLE_DEG * Math.PI/180);
Â Â if(ady <= adx * tan){
Â Â Â Â if(movingHandle === "p1") wall.y1 = wall.y2;
Â Â Â Â else wall.y2 = wall.y1;
Â Â Â Â return;
Â Â }
Â Â if(adx <= ady * tan){
Â Â Â Â if(movingHandle === "p1") wall.x1 = wall.x2;
Â Â Â Â else wall.x2 = wall.x1;
Â Â }
}
Â 
/* ===== rect helpers ===== */
function isSmallRoom(it){
Â Â if(!it || it.type !== 'room') return false;
Â Â const masu = (it.w/GRID_SIZE) * (it.h/GRID_SIZE);
Â Â return masu <= SMALL_ROOM_MAX_MASU;
}
function rectMoveHandleCenter(it){
Â Â return { x: it.x + it.w/2, y: it.y + it.h/2 };
}
function rectMoveHandleHit(worldP, it){
Â Â const c = rectMoveHandleCenter(it);
Â Â const r = MOVE_HANDLE_HIT / scale;
Â Â return Math.hypot(worldP.x - c.x, worldP.y - c.y) <= r;
}
Â 
/* ===== draw ===== */
function drawGrid(){
Â Â ctx.strokeStyle = "#e5e5ea";
Â Â ctx.lineWidth = 0.5 / scale;
Â Â const range = 1600;
Â Â for (let x = -range; x <= range; x += GRID_SIZE) {
Â Â Â Â ctx.beginPath();
Â Â Â Â ctx.moveTo(x, -range); ctx.lineTo(x, range); ctx.stroke();
Â Â }
Â Â for (let y = -range; y <= range; y += GRID_SIZE) {
Â Â Â Â ctx.beginPath();
Â Â Â Â ctx.moveTo(-range, y); ctx.lineTo(range, y); ctx.stroke();
Â Â }
}
Â 
/* â˜…é‡ãªã‚Šå¯¾ç­–ï¼šfillâ†’strokeâ†’label ã‚’åˆ†ã‘ã‚‹ï¼ˆä¸‹ã®éƒ¨å±‹ã‚‚è¼ªéƒ­ãŒè¦‹ãˆã‚‹ï¼‰ */
function drawRectItems(){
Â Â const rects = items.filter(i => i.type !== 'wallLine');
// 1) fill
Â Â rects.forEach(item => {
Â Â Â Â ctx.fillStyle = item.color;
Â Â Â Â ctx.globalAlpha = item.type==='room' ? 0.82 : 1.0;
Â Â Â Â ctx.fillRect(item.x, item.y, item.w, item.h);
Â Â Â Â ctx.globalAlpha = 1.0;
Â 
Â Â Â Â if(item.locked){
Â Â Â Â Â Â ctx.fillStyle = "rgba(0,0,0,0.08)";
Â Â Â Â Â Â ctx.fillRect(item.x, item.y, item.w, item.h);
Â Â Â Â }
Â Â });
// 2) stroke (small rooms double border)
Â Â rects.forEach(item => {
Â Â Â Â const isFrame = item.type === 'frame';
Â Â Â Â const baseStroke = isFrame ? "#cfcfd6" : "#333";
Â 
Â Â Â Â if(isSmallRoom(item)){
Â Â Â Â Â Â // outer white halo
Â Â Â Â Â Â ctx.strokeStyle = "rgba(255,255,255,0.95)";
Â Â Â Â Â Â ctx.lineWidth = 4 / scale;
Â Â Â Â Â Â ctx.strokeRect(item.x, item.y, item.w, item.h);
Â Â Â Â Â Â // inner dark
Â Â Â Â Â Â ctx.strokeStyle = baseStroke;
Â Â Â Â Â Â ctx.lineWidth = 2 / scale;
Â Â Â Â Â 
Â Â Â Â Â Â ctx.strokeRect(item.x, item.y, item.w, item.h);
Â Â Â Â }else{
Â Â Â Â Â Â ctx.strokeStyle = baseStroke;
Â Â Â Â Â Â ctx.lineWidth = 1 / scale;
Â Â Â Â Â Â ctx.strokeRect(item.x, item.y, item.w, item.h);
Â Â Â Â }
Â Â });
// 3) label (white stroke text)
Â Â rects.forEach(item => {
Â Â Â Â const label = item.locked ? `${item.label} ğŸ”’` : (item.label || "");
Â Â Â Â if(!label) return;
Â 
Â Â Â Â const x = item.x + 6/scale;
Â Â Â Â const y = item.y + 18/scale;
Â 
Â Â Â Â ctx.font = `900 ${13/scale}px sans-serif`;
Â 
Â Â Â Â // â˜…ç™½ãƒ•ãƒ
Â Â Â Â ctx.lineJoin = "round";
Â Â Â Â ctx.lineWidth = 4/scale;
Â Â Â Â ctx.strokeStyle = "rgba(255,255,255,0.95)";
Â Â Â Â ctx.strokeText(label, x, y);
Â 
Â Â Â Â ctx.fillStyle = "#111";
Â Â Â Â ctx.fillText(label, x, y);
Â Â });
}
Â 
function drawWallLine(wall){
Â Â const thick = wall.thick || WALL_DEFAULT_THICK;
Â Â ctx.save();
Â Â ctx.lineCap = "round";
Â Â ctx.strokeStyle = wall.color || "#616161";
Â Â ctx.lineWidth = thick / scale;
Â Â ctx.beginPath();
Â Â ctx.moveTo(wall.x1, wall.y1);
Â Â ctx.lineTo(wall.x2, wall.y2);
Â Â ctx.stroke();
Â 
Â Â const mx = (wall.x1 + wall.x2)/2;
Â Â const my = (wall.y1 + wall.y2)/2;
Â Â ctx.fillStyle = "#111";
Â Â ctx.font = `bold ${12/scale}px sans-serif`;
Â 
Â Â const text = wall.locked ?
Â Â Â Â `${wall.label} ğŸ”’` : wall.label;
Â 
Â Â // å£ãƒ©ãƒ™ãƒ«ã‚‚ç™½ãƒ•ãƒ
Â Â ctx.lineJoin = "round";
Â Â ctx.lineWidth = 4/scale;
Â Â ctx.strokeStyle = "rgba(255,255,255,0.95)";
Â Â ctx.strokeText(text, mx + 8/scale, my - 8/scale);
Â Â ctx.fillText(text, mx + 8/scale, my - 8/scale);
Â 
Â Â ctx.restore();
}
Â 
function drawWallSelection(wall){
Â Â ctx.save();
Â Â ctx.lineCap = "round";
Â Â ctx.strokeStyle = "#007AFF";
Â Â ctx.lineWidth = ((wall.thick || WALL_DEFAULT_THICK) + 4) / scale;
Â Â ctx.globalAlpha = 0.25;
Â Â ctx.beginPath();
Â Â ctx.moveTo(wall.x1, wall.y1);
Â Â ctx.lineTo(wall.x2, wall.y2);
Â Â ctx.stroke();
Â Â ctx.globalAlpha = 1;
Â 
Â Â if(!wall.locked){
Â Â Â Â const r = WALL_HANDLE_R / scale;
Â Â Â Â ctx.fillStyle = "#fff";
Â Â Â Â ctx.strokeStyle = "#007AFF";
Â Â Â Â ctx.lineWidth = 2/scale;
Â Â Â Â ctx.beginPath(); ctx.arc(wall.x1, wall.y1, r, 0, Math.PI*2); ctx.fill(); ctx.stroke();
Â Â Â Â ctx.beginPath();
Â Â Â Â ctx.arc(wall.x2, wall.y2, r, 0, Math.PI*2); ctx.fill(); ctx.stroke();
Â Â }
Â Â ctx.restore();
}
Â 
/* â˜…ç§»å‹•ãƒãƒ³ãƒ‰ãƒ«æç”» */
function drawMoveHandleRect(it){
Â Â const c = rectMoveHandleCenter(it);
Â Â const r = MOVE_HANDLE_R / scale;
Â 
Â Â ctx.save();
Â Â ctx.fillStyle = "#fff";
Â Â ctx.strokeStyle = "#007AFF";
Â Â ctx.lineWidth = 2/scale;
Â 
Â Â ctx.beginPath();
Â Â ctx.arc(c.x, c.y, r, 0, Math.PI*2); ctx.fill(); ctx.stroke();
Â 
Â Â // cross
Â Â ctx.beginPath();
Â Â ctx.moveTo(c.x - r*0.55, c.y);
Â Â ctx.lineTo(c.x + r*0.55, c.y);
Â Â ctx.moveTo(c.x, c.y - r*0.55);
Â Â ctx.lineTo(c.x, c.y + r*0.55);
Â Â ctx.stroke();
Â 
Â Â ctx.restore();
}
Â 
function drawSizeBadge(it){
Â Â const mw = (it.w / GRID_SIZE).toFixed(1).replace('.0','');
Â Â const mh = (it.h / GRID_SIZE).toFixed(1).replace('.0','');
Â Â const text = (it.type === 'frame') ? `å¤–æ : ${mw}Ã—${mh}ãƒã‚¹` : `${mw}Ã—${mh}ãƒã‚¹`;
Â Â const pad = 8/scale;
Â Â ctx.save();
Â Â ctx.font = `900 ${12/scale}px sans-serif`;
Â Â const w = ctx.measureText(text).width + pad*2;
Â Â const h = 22/scale;
Â Â const x = it.x;
Â Â const y = it.y - (h + 8/scale);
Â 
Â Â ctx.fillStyle = "rgba(0,122,255,0.92)";
Â Â ctx.beginPath();
Â Â const rx = 10/scale;
Â Â ctx.roundRect(x, y, w, h, rx);
Â Â ctx.fill();
Â 
Â Â ctx.fillStyle = "#fff";
Â Â ctx.fillText(text, x + pad, y + 15/scale);
Â Â ctx.restore();
}
Â 
function drawMerged(){
Â Â const roomMap = {};
Â Â const frameMap = {};
Â Â const groups = {};
Â Â const sub = 16;
Â Â items.forEach((item, index) => {
Â Â Â Â if(item.type === 'wallLine') return;
Â 
Â Â Â Â if (item.type !== 'frame') {
Â Â Â Â Â Â if (!groups[item.label]) groups[item.label] = { label: item.label, totalMasu: 0, textX: 0, textY: 0, lastIdx: -1 };
Â Â Â Â Â Â groups[item.label].totalMasu += (item.w / GRID_SIZE) * (item.h / GRID_SIZE);
Â Â Â Â Â Â if (index > groups[item.label].lastIdx) {
Â Â Â Â Â Â Â Â groups[item.label].textX = item.x + item.w/2;
Â Â Â Â Â Â Â Â groups[item.label].textY = item.y + item.h/2;
Â Â Â Â Â Â Â Â groups[item.label].lastIdx = index;
Â Â Â Â 
Â Â Â Â Â Â }
Â Â Â Â }
Â 
Â Â Â Â for (let x = item.x; x < item.x + item.w; x += sub) {
Â Â Â Â Â Â for (let y = item.y; y < item.y + item.h; y += sub) {
Â Â Â Â Â Â Â Â const pos = `${x},${y}`;
Â Â Â Â Â Â Â Â if (item.type === 'frame') frameMap[pos] = item.label;
Â Â Â Â Â Â Â Â else roomMap[pos] = { label: item.label, color: item.color };
Â Â Â Â Â Â }
Â Â Â Â }
Â Â });
Â Â items.forEach(item => {
Â Â Â Â if(item.type === 'wallLine') return;
Â Â Â Â ctx.fillStyle = item.type === 'frame' ? "#f8f8f8" : item.color;
Â Â Â Â ctx.fillRect(item.x, item.y, item.w, item.h);
Â Â });
Â Â const drawEdge = (map, color, width) => {
Â Â Â Â ctx.strokeStyle = color;
Â Â Â Â ctx.lineWidth = width / scale;
Â Â Â Â for (const pos in map) {
Â Â Â Â Â Â const [x, y] = pos.split(',').map(Number);
Â Â Â Â Â Â const label = map[pos].label || map[pos];
Â Â Â Â Â Â [{dx:0, dy:-sub}, {dx:0, dy:sub}, {dx:-sub, dy:0}, {dx:sub, dy:0}].forEach(d => {
Â Â Â Â Â Â Â Â if ((map[`${x+d.dx},${y+d.dy}`]?.label || map[`${x+d.dx},${y+d.dy}`]) !== label) {
Â Â Â Â Â Â Â Â Â Â ctx.beginPath();
Â Â Â Â Â Â Â Â Â Â if(d.dy!==0){
Â Â Â Â Â Â Â Â Â Â Â Â ctx.moveTo(x, y+(d.dy>0?sub:0));
Â Â Â Â Â Â Â Â Â Â Â Â ctx.lineTo(x+sub, y+(d.dy>0?sub:0));
Â Â Â Â Â Â Â Â Â Â } else {
Â Â Â Â Â Â Â Â Â Â Â Â ctx.moveTo(x+(d.dx>0?sub:0), 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â y);
Â Â Â Â Â Â Â Â Â Â Â Â ctx.lineTo(x+(d.dx>0?sub:0), y+sub);
Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â ctx.stroke();
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â });
Â Â Â Â }
Â Â };
Â 
Â Â drawEdge(roomMap, "#333", 2);
Â Â drawEdge(frameMap, "#111", 6);
Â 
Â Â for (const key in groups) {
Â Â Â Â const g = groups[key];
Â Â Â Â ctx.fillStyle = "#111";
Â Â Â Â ctx.textAlign = "center";
Â Â Â Â ctx.font = `bold ${14/scale}px sans-serif`;
Â 
Â Â Â Â // ç™½ãƒ•ãƒ
Â Â Â Â ctx.lineJoin="round";
Â Â Â Â ctx.lineWidth=4/scale;
Â Â Â Â ctx.strokeStyle="rgba(255,255,255,0.95)";
Â Â Â Â ctx.strokeText(g.label, g.textX, g.textY - 4/scale);
Â Â Â Â ctx.fillText(g.label, g.textX, g.textY - 4/scale);
Â 
Â Â Â Â let subText = "";
Â Â Â Â if (el('showJou').checked) subText += `${(g.totalMasu/2).toFixed(1)}ç•³ `;
Â Â Â Â if (el('showTsubo').checked) subText += `${(g.totalMasu/4).toFixed(2)}åª`;
Â 
Â Â Â Â ctx.font = `${11/scale}px sans-serif`;
Â Â Â Â ctx.lineWidth=4/scale;
Â Â Â Â ctx.strokeText(subText, g.textX, g.textY + 12/scale);
Â Â Â Â ctx.fillText(subText, g.textX, g.textY + 12/scale);
Â Â Â Â ctx.textAlign = "left";
Â Â }
Â 
Â Â items.forEach(it => { if(it.type === 'wallLine') drawWallLine(it); });
}
Â 
/* â˜…è¨ˆæ¸¬æç”»ï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«è¡¨ç¤ºï¼‰ */
function drawMeasurement(){
Â Â if(!measurePoints.length) return;
Â Â Â 
Â Â ctx.save();
Â Â ctx.fillStyle = "#FF2D55";
Â Â ctx.strokeStyle = "#FF2D55";
Â Â ctx.lineWidth = 2/scale;
Â Â Â 
Â Â // draw points
Â Â const r = 5/scale;
Â Â measurePoints.forEach(p => {
Â Â Â Â ctx.beginPath(); ctx.arc(p.x, p.y, r, 0, Math.PI*2); ctx.fill();
Â Â });
Â 
Â Â // draw line
Â Â if(measurePoints.length === 2){
Â Â Â Â const [p1, p2] = measurePoints;
Â Â Â Â ctx.beginPath(); ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y); ctx.stroke();
Â Â Â Â Â 
Â Â Â Â // distance text
Â Â Â Â const dist = Math.hypot(p2.x - p1.x, p2.y - p1.y);
Â Â Â Â const masVal = dist / GRID_SIZE;
Â Â Â Â // 1ãƒã‚¹ = 0.91m
Â Â Â Â const meters = (masVal * 0.91).toFixed(2);
Â Â Â Â Â 
Â Â Â Â const midX = (p1.x + p2.x)/2;
Â Â Â Â const midY = (p1.y + p2.y)/2;
Â Â Â Â Â 
Â Â Â Â ctx.font = `bold ${16/scale}px sans-serif`;
Â Â Â Â ctx.textAlign = "center";
Â Â Â Â ctx.textBaseline = "bottom";
Â Â Â Â Â 
Â Â Â Â // è¡¨ç¤ºã‚’ãƒ¡ãƒ¼ãƒˆãƒ«ã«
Â Â Â Â const txt = `${meters}m`;
Â Â Â Â Â 
Â Â Â Â ctx.lineWidth = 4/scale;
Â Â Â Â ctx.lineJoin = "round";
Â Â Â Â ctx.strokeStyle = "rgba(255,255,255,0.9)";
Â Â Â Â ctx.strokeText(txt, midX, midY - 6/scale);
Â Â Â Â ctx.fillText(txt, midX, midY - 6/scale);
Â Â }
Â Â Â 
Â Â ctx.restore();
}
Â 
window.draw = function(){
Â Â ctx.save();
Â Â ctx.clearRect(0, 0, canvas.width, canvas.height);
Â 
Â Â ctx.translate(canvas.width/2 + camera.x, canvas.height/2 + camera.y);
Â Â ctx.scale(scale, scale);
Â 
Â Â drawGrid();
Â 
Â Â if(isMerged) drawMerged();
Â Â else{
Â Â Â Â drawRectItems();
Â Â Â Â items.forEach(it => { if(it.type === 'wallLine') drawWallLine(it); });
Â Â }
Â 
Â Â if(selectedItem && !(isMerged && selectedItem.type === 'frame')){
Â Â Â Â if(selectedItem.type === 'wallLine'){
Â Â Â Â Â Â drawWallSelection(selectedItem);
Â Â Â Â }else{
Â Â Â Â Â Â ctx.strokeStyle = "#007AFF";
Â Â Â Â Â Â ctx.lineWidth = 3 / scale;
Â Â Â Â Â Â ctx.strokeRect(selectedItem.x, selectedItem.y, selectedItem.w, selectedItem.h);
// â˜…ç§»å‹•ãƒãƒ³ãƒ‰ãƒ«
Â Â Â Â Â Â if(!selectedItem.locked){
Â Â Â Â Â Â Â Â drawMoveHandleRect(selectedItem);
// resize handle
Â Â Â Â Â Â Â Â ctx.fillStyle = "#fff";
Â Â Â Â Â Â Â Â ctx.strokeStyle = "#007AFF";
Â Â Â Â Â Â Â Â ctx.lineWidth = 2/scale;
Â Â Â Â Â Â Â Â ctx.beginPath();
Â Â Â Â Â Â Â Â ctx.arc(selectedItem.x + selectedItem.w, selectedItem.y + selectedItem.h, 16/scale, 0, Math.PI*2);
Â Â Â Â Â Â Â Â ctx.fill(); ctx.stroke();
Â Â Â Â Â Â }
Â 
Â Â Â Â Â Â // â˜…å¤–æ ã‚µã‚¤ã‚ºãŒã‚ã‹ã‚‹ï¼ˆãƒ‰ãƒ©ãƒƒã‚°ä¸­/ãƒªã‚µã‚¤ã‚ºä¸­ï¼‰
Â Â Â Â Â Â if(dragActive && pendingItem === selectedItem){
Â Â Â Â Â Â Â Â drawSizeBadge(selectedItem);
Â Â Â Â Â Â }
Â Â Â Â }
Â Â }else if(selectedItem && selectedItem.type === 'frame' && isMerged){
Â Â Â Â // çµåˆä¸­ã¯ãƒ•ãƒ¬ãƒ¼ãƒ é¸æŠæç”»ã—ãªã„ä»•æ§˜ã ãŒã€ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã¯ã‚µã‚¤ã‚ºãƒãƒƒã‚¸ã ã‘å‡ºã™
Â Â Â Â if(dragActive && pendingItem === selectedItem){
Â Â Â Â Â Â drawSizeBadge(selectedItem);
Â Â Â Â }
Â Â }
Â 
Â Â // â˜…è¨ˆæ¸¬ãƒ¢ãƒ¼ãƒ‰æç”»
Â Â if(isMeasureMode) drawMeasurement();
Â 
Â Â ctx.restore();
Â 
Â Â updateSummary();
Â Â syncBottomBarState();
Â Â syncHistoryButtons();
};
Â 
function fitToFrame(){
Â Â const frames = items.filter(i => i.type === 'frame');
Â Â const targets = frames.length ? frames : items.filter(i => i.type !== 'wallLine');
Â Â if (!targets.length) return;
Â Â let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
Â Â targets.forEach(it => {
Â Â Â Â if(it.type === 'wallLine') return;
Â Â Â Â minX = Math.min(minX, it.x);
Â Â Â Â minY = Math.min(minY, it.y);
Â Â Â Â maxX = Math.max(maxX, it.x + it.w);
Â Â Â Â maxY = Math.max(maxY, it.y + it.h);
Â Â });
Â Â const cx = (minX + maxX)/2;
Â Â const cy = (minY + maxY)/2;
Â Â camera = { x: -cx * scale, y: -cy * scale };
Â Â draw();
}
Â 
/* ===== UI wiring ===== */
function init(){
Â Â presets = loadPresets();
Â Â renderPresetChips();
Â 
Â Â resizeCanvas();
Â Â window.addEventListener('resize', resizeCanvas);
Â 
Â Â el('segEdit').onclick = () => setMergedMode(false);
Â Â el('segMerge').onclick = () => setMergedMode(true);
Â 
Â Â // â˜…è¨ˆæ¸¬ãƒœã‚¿ãƒ³
Â Â el('measureBtn').onclick = () => {
Â Â Â Â isMeasureMode = !isMeasureMode;
Â Â Â Â measurePoints = [];
Â Â Â Â selectedItem = null;
Â Â Â Â Â 
Â Â Â Â if(isMeasureMode){
Â Â Â Â Â Â el('measureBtn').classList.add('active');
Â Â Â Â Â Â el('measureBtn').classList.remove('gray');
Â Â Â Â }else{
Â Â Â Â Â Â el('measureBtn').classList.remove('active');
Â Â Â Â Â Â el('measureBtn').classList.add('gray');
Â Â Â Â }
Â Â Â Â draw();
Â Â };
Â 
Â Â el('undoBtn').onclick = undo;
Â Â el('redoBtn').onclick = redo;
Â Â syncHistoryButtons();
Â 
Â Â const params = new URLSearchParams(window.location.search);
Â Â layoutId = params.get('id') || null;
Â 
Â Â if(layoutId){
Â Â Â Â getDoc(doc(db, "layouts", layoutId)).then(snap => {
Â Â Â Â Â Â if(snap.exists()){
Â Â Â Â Â Â Â Â const data = snap.data();
Â Â Â Â Â Â Â Â items = (data.items || []).map(i => ({...i}));
Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â // â˜…ã‚¿ã‚¤ãƒˆãƒ«èª­ã¿è¾¼ã¿
Â Â Â Â Â Â Â Â currentTitle = data.title || "MORIYASUğŸ ";
Â Â Â Â Â Â Â Â el('topTitle').innerText = currentTitle;
Â 
Â Â Â Â Â Â Â Â ensureIds();
Â Â Â Â Â Â Â Â normalizeZ();
Â Â Â Â Â Â Â Â isMerged = !!data.isMerged;
Â Â Â Â Â Â Â Â updateSegmentUI();
Â Â Â Â Â Â Â Â draw();
Â Â Â Â Â Â Â Â // ä¿å­˜ä¸€è¦§æ›´æ–°
Â Â Â Â Â Â Â Â upsertLayoutMeta(layoutId, { title: currentTitle, updatedAt: Date.now() });
Â Â Â 
Â Â Â Â Â Â }else{
Â Â Â Â Â Â Â Â addRect('å¤–æ ', 2, 2, '#f8f8f8', 'frame'); // â˜…åˆæœŸå¤–æ : 2Ã—2
Â Â Â Â Â Â Â Â updateSegmentUI();
Â Â Â Â Â Â }
Â Â Â Â });
Â Â }else{
Â Â Â Â addRect('å¤–æ ', 2, 2, '#f8f8f8', 'frame'); // â˜…åˆæœŸå¤–æ : 2Ã—2
Â Â Â Â updateSegmentUI();
Â Â }
}
Â 
el('openHelpBtn').onclick = () => el('helpModal').style.display = 'flex';
el('helpModal').onclick = () => el('helpModal').style.display = 'none';
Â 
// â˜…ä¿å­˜ãƒœã‚¿ãƒ³: æ–°è¦/æ—¢å­˜ ä¿å­˜å‡¦ç†ï¼†ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
el('saveBtn').onclick = async () => {
Â Â if(!layoutId){
Â Â Â Â const r = await addDoc(collection(db, "layouts"), { 
Â Â Â Â Â Â items, 
Â Â Â Â Â Â isMerged, 
Â Â Â Â Â Â title: currentTitle,
Â Â Â Â Â Â updatedAt: new Date() 
Â Â Â Â });
Â Â Â Â layoutId = r.id;
Â Â Â Â const newUrl = `${window.location.origin}${window.location.pathname}?id=${layoutId}`;
Â Â Â Â history.replaceState(null, "", newUrl);
Â Â }
Â Â Â 
Â Â await saveLayoutToFirestore();
Â Â upsertLayoutMeta(layoutId, { title: currentTitle, updatedAt: Date.now() });
Â 
Â Â el('shareUrlInput').value = `${window.location.origin}${window.location.pathname}?id=${layoutId}`;
Â Â el('layoutTitleInput').value = currentTitle; // ç¾åœ¨ã®åå‰ã‚’ã‚»ãƒƒãƒˆ
Â Â el('saveModal').style.display = 'flex';
};
Â 
// â˜…ã‚¿ã‚¤ãƒˆãƒ«å¤‰æ›´å³åæ˜ 
el('layoutTitleInput').addEventListener('input', (e) => {
Â Â currentTitle = e.target.value.trim() || "MORIYASUğŸ ";
Â Â el('topTitle').innerText = currentTitle;
Â Â Â 
Â Â // ä¿å­˜æ¸ˆã¿ã®å ´åˆã¯ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æ›´æ–°ï¼†ã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–
Â Â if(layoutId){
Â Â Â Â scheduleAutoSave();
Â Â Â Â upsertLayoutMeta(layoutId, { title: currentTitle });
Â Â }
});
Â 
el('saveAsBtn').onclick = async () => {
Â Â // åˆ¥åã§ä¿å­˜ï¼ˆæ–°ã—ã„IDã‚’ä½œã£ã¦è¤‡æ•°é–“å–ã‚Šã‚’æŒã¦ã‚‹ï¼‰
Â Â const r = await addDoc(collection(db, "layouts"), { 
Â Â Â Â items, 
Â Â Â Â isMerged, 
Â Â Â Â title: currentTitle, // ã‚¿ã‚¤ãƒˆãƒ«å¼•ãç¶™ã
Â Â Â Â updatedAt: new Date() 
Â Â });
Â Â layoutId = r.id;
Â Â const newUrl = `${window.location.origin}${window.location.pathname}?id=${layoutId}`;
Â Â history.replaceState(null, "", newUrl);
Â Â Â 
Â Â upsertLayoutMeta(layoutId, { title: currentTitle, updatedAt: Date.now() });
Â Â el('shareUrlInput').value = newUrl;
Â Â alert("åˆ¥åã§ä¿å­˜ã—ã¾ã—ãŸï¼ˆæ–°ã—ã„URLã«ãªã‚Šã¾ã—ãŸï¼‰");
};
Â 
el('openLayoutsBtn').onclick = () => {
Â Â renderLayoutList();
Â Â el('layoutsModal').style.display = 'flex';
};
el('layoutsCloseBtn').onclick = () => el('layoutsModal').style.display = 'none';
el('layoutsModal').onclick = (e) => { if(e.target.id === 'layoutsModal') el('layoutsModal').style.display = 'none'; };
el('copyUrlBtn').onclick = () => {
Â Â navigator.clipboard.writeText(el('shareUrlInput').value);
Â Â alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
};
el('closeSaveModalBtn').onclick = () => el('saveModal').style.display = 'none';
el('colorPicker').oninput = (e) => {
Â Â if(!selectedItem) return;
Â Â pushHistory();
Â Â selectedItem.color = e.target.value;
Â Â draw();
Â Â scheduleAutoSave();
};
Â 
el('fitBtn').onclick = fitToFrame;
el('centerBtn').onclick = () => { camera = { x: 0, y: 0 }; scale = 1.0; draw(); };
// â˜…ãƒã‚§ãƒƒã‚¯å¤‰æ›´ã§å³åæ˜ ï¼ˆshowM2ã‚‚ã“ã“ã§åŠ¹ãï¼‰
document.querySelectorAll('input[type="checkbox"]').forEach(c => c.onchange = draw);
Â 
// Label modal OK/CANCELï¼ˆâ˜…è¿½åŠ ãƒ¢ãƒ¼ãƒ‰åˆ†å²ï¼‰
el('labelCancelBtn').onclick = closeLabelModal;
el('labelOkBtn').onclick = () => {
Â Â const name = el('labelInput').value.trim();
Â Â if(!name) return;
Â 
Â Â if(labelModalMode === "add"){
Â Â Â Â closeLabelModal();
Â Â Â Â addRect(name, 4, 4, addPendingColor || "#FFF3E0", 'room');
Â Â Â Â return;
Â Â }
Â Â applyLabel(false, null);
};
el('labelModal').onclick = (e) => { if (e.target.id === 'labelModal') closeLabelModal(); };
el('labelInput').addEventListener('keydown', (e) => {
Â Â if (e.key === 'Enter') el('labelOkBtn').click();
});
// Preset editor (A+B+D)
el('openPresetBtn').onclick = () => {
Â Â el('presetModal').style.display = 'flex';
Â Â presetSearchQuery = "";
Â Â el('presetSearch').value = "";
Â Â renderPresetEditorList();
};
el('presetSearch').addEventListener('input', (e) => {
Â Â presetSearchQuery = (e.target.value || "").trim();
Â Â renderPresetEditorList();
});
el('presetCloseBtn').onclick = () => el('presetModal').style.display = 'none';
el('presetModal').onclick = (e) => { if(e.target.id === 'presetModal') el('presetModal').style.display = 'none'; };
el('presetAddBtn').onclick = () => {
Â Â presets.push({ name: "éƒ¨å±‹", color: "#FFF3E0" });
Â Â renderPresetEditorList();
};
el('presetSaveBtn').onclick = () => {
Â Â presets = presets
Â Â Â Â .map(p => ({ name: (p.name||"éƒ¨å±‹").trim().slice(0,12) || "éƒ¨å±‹", color: p.color || "#FFF3E0" }))
Â Â Â Â .filter(p => p.name.length > 0);
Â Â savePresets();
Â Â renderPresetChips();
Â Â el('presetModal').style.display = 'none';
};
Â 
// Menu modal
el('menuCloseBtn').onclick = closeMenu;
el('menuModal').onclick = (e) => { if (e.target.id === 'menuModal') closeMenu(); };
el('menuEditBtn').onclick = () => { const it = menuItem;
closeMenu(); if(it) openLabelEditor(it); };
el('menuDupBtn').onclickÂ  = () => { const it = menuItem; closeMenu(); if(it) duplicateItem(it); };
el('menuDelBtn').onclickÂ  = () => { const it = menuItem; closeMenu(); if(it) deleteItem(it); };
el('menuFrontBtn').onclick= () => { const it = menuItem; closeMenu(); if(it) bringFront(it); };
el('menuBackBtn').onclick = () => { const it = menuItem; closeMenu(); if(it) bringBack(it); };
el('menuLockBtn').onclick = () => { const it = menuItem; closeMenu(); if(it) toggleLock(it); };
// Bottom actions
el('addGenericRoomBtn2').onclick = () => {
Â Â editingItem = null;
Â Â addPendingColor = addPendingColor || "#FFF3E0";
Â Â openLabelModal("add");
};
el('addFrameBtn2').onclick = () => addRect('å¤–æ ', 2, 2, '#f8f8f8', 'frame'); // â˜…å¤–æ åˆæœŸ 2Ã—2
el('addWallBtn2').onclick = addWallLine;
el('copyBtn2').onclick = () => { if(selectedItem) duplicateItem(selectedItem); };
el('resetBtn2').onclick = () => {
Â Â if(selectedItem) deleteItem(selectedItem);
Â Â else if(confirm("å…¨æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) {
Â Â Â Â pushHistory();
Â Â Â Â items = [];
Â Â Â Â selectedItem = null;
Â Â Â Â addRect('å¤–æ ', 2, 2, '#f8f8f8', 'frame');
Â Â }
};
/* ===== touch handling (longpress vs drag) ===== */
function clearTouchState(){
Â Â if(longPressTimer) clearTimeout(longPressTimer);
Â Â longPressTimer = null;
Â 
Â Â pressStart = null;
Â Â pressStartWorld = null;
Â Â pendingItem = null;
Â Â pendingWallHandle = null;
Â Â pendingAction = null;
Â Â dragActive = false;
Â Â rectDragOffset = null;
Â Â wallMoveOffset = null;
Â Â emptyTapCandidate = false;
}
Â 
function startLongPress(item){
Â Â if(longPressTimer) clearTimeout(longPressTimer);
Â Â longPressTimer = setTimeout(() => {
Â Â Â Â if(!dragActive && pendingItem === item){
Â Â Â Â Â Â openMenu(item);
Â Â Â Â }
Â Â }, 450);
}
Â 
function getPinchInfo(touches){
Â Â const a = touches[0], b = touches[1];
Â Â const dx = b.clientX - a.clientX;
Â Â const dy = b.clientY - a.clientY;
Â Â const dist = Math.hypot(dx, dy);
Â Â const mid = { x: (a.clientX + b.clientX)/2, y: (a.clientY + b.clientY)/2 };
Â Â return { dist, mid };
}
Â 
canvas.addEventListener('touchstart', (e) => {
Â Â if(e.touches.length === 2){
Â Â Â Â pinchActive = true;
Â Â Â Â clearTouchState();
Â Â Â Â gestureSnapshot = snapshot();
Â 
Â Â Â Â const { dist, mid } = getPinchInfo(e.touches);
Â Â Â Â pinchStartDist = dist;
Â Â Â Â pinchStartScale = scale;
Â Â Â Â pinchWorldMid = screenToWorld(mid.x, mid.y);
Â Â Â Â return;
Â Â }
Â 
Â Â if(e.touches.length !== 1) return;
Â Â const t = e.touches[0];
Â 
Â Â const now = Date.now();
Â Â if(now - lastTapTime < 300 && selectedItem && !isMerged){
Â Â Â Â openLabelEditor(selectedItem);
Â Â Â Â return;
Â Â }
Â Â lastTapTime = now;
Â 
Â Â clearTouchState();
Â Â 
Â Â pressStart = { clientX: t.clientX, clientY: t.clientY };
Â Â pressStartWorld = screenToWorld(t.clientX, t.clientY);
Â Â const worldP = pressStartWorld;
Â 
Â Â // â˜…è¨ˆæ¸¬ãƒ¢ãƒ¼ãƒ‰ï¼šã‚¯ãƒªãƒƒã‚¯ã®ã¿å‡¦ç†ã—ã¦ãƒªã‚¿ãƒ¼ãƒ³
Â Â if(isMeasureMode){
Â Â Â Â const snap = getSnapStep();
Â Â Â Â const mx = getSnapped(worldP.x, snap);
Â Â Â Â const my = getSnapped(worldP.y, snap);
Â Â Â Â Â 
Â Â Â Â // 3ç‚¹ç›®ã¯ãƒªã‚»ãƒƒãƒˆ
Â Â Â Â if(measurePoints.length >= 2){
Â Â Â Â Â Â measurePoints = [];
Â Â Â Â }
Â Â Â Â measurePoints.push({x:mx, y:my});
Â Â Â Â draw();
Â Â Â Â return;
Â Â }
Â 
Â Â let found = null;
Â Â let wallHandle = null;
Â 
Â Â for (let i = items.length-1; i >= 0; i--) {
Â Â Â Â if (!isMerged || items[i].type !== 'frame') {
Â Â Â Â Â Â const it = items[i];
Â 
Â Â Â Â Â Â if(it.type === 'wallLine'){
Â Â Â Â Â Â Â Â const r = wallHitTest(worldP, it);
Â Â Â Â Â Â Â Â if(r.hit){
Â Â Â Â Â Â Â Â Â Â found = it; wallHandle = r.handle; break;
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â } else {
Â Â Â Â Â Â Â Â if (worldP.x >= it.x && worldP.x <= it.x+it.w && worldP.y >= it.y && worldP.y <= it.y+it.h) {
Â Â Â Â Â Â Â Â Â Â found = it;
Â Â Â Â Â Â Â Â Â Â break;
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â }
Â Â Â Â }
Â Â }
Â 
Â Â if(found){
Â Â Â Â selectedItem = found;
Â Â Â Â pendingItem = found;
Â 
Â Â Â Â startLongPress(found);
Â 
Â Â Â Â if(found.locked){
Â Â Â Â Â Â pendingAction = null;
Â Â Â Â Â Â draw();
Â Â Â Â Â Â return;
Â Â Â Â }
Â 
Â Â Â Â if(found.type === 'wallLine'){
Â Â Â Â Â Â pendingWallHandle = wallHandle;
Â Â Â Â Â Â if(wallHandle === "p1" || wallHandle === "p2") pendingAction = wallHandle;
Â Â Â Â Â Â else pendingAction = "moveWall";
Â Â Â Â }else{
Â Â Â Â Â Â // â˜…ç§»å‹•ãƒãƒ³ãƒ‰ãƒ«å„ªå…ˆï¼ˆèª¤ãƒªã‚µã‚¤ã‚ºé˜²æ­¢ï¼‰
Â Â Â Â Â Â if(rectMoveHandleHit(worldP, found)){
Â Â Â Â Â Â Â Â pendingAction = "moveRect";
Â Â Â Â Â Â }else{
Â Â Â Â Â Â Â Â // â˜…ãƒªã‚µã‚¤ã‚ºåˆ¤å®šã‚’ã‚„ã‚„å³ã—ãï¼ˆå°ç‰©ã»ã©ï¼‰
Â Â Â Â Â Â Â Â const base = isSmallRoom(found) ?
Â Â Â Â Â Â Â Â Â Â 16 : 22; // screen px
Â Â Â Â Â Â Â Â const nearResize = (Math.abs(worldP.x-(found.x+found.w)) < base/scale) && (Math.abs(worldP.y-(found.y+found.h)) < base/scale);
Â Â Â Â Â Â Â Â pendingAction = nearResize ? "resizeRect" : "moveRect";
Â Â Â Â Â Â }
Â Â Â Â }
Â Â }else{
Â Â Â Â // â˜…ä½•ã‚‚ãªã„æ‰€ï¼šã‚¿ãƒƒãƒ—ãªã‚‰é¸æŠè§£é™¤ã€ãƒ‰ãƒ©ãƒƒã‚°ãªã‚‰ãƒ‘ãƒ³
Â Â Â Â emptyTapCandidate = true;
Â Â Â Â pendingAction = "pan";
Â Â Â Â pendingItem = null;
Â Â }
Â 
Â Â draw();
});
canvas.addEventListener('touchmove', (e) => {
Â Â e.preventDefault();
Â 
Â Â if(pinchActive && e.touches.length === 2){
Â Â Â Â const { dist, mid } = getPinchInfo(e.touches);
Â 
Â Â Â Â const factor = dist / pinchStartDist;
Â Â Â Â scale = clamp(pinchStartScale * factor, 0.5, 3.0);
Â 
Â Â Â Â const rect = canvas.getBoundingClientRect();
Â Â Â Â const cx = canvas.width/2;
Â Â Â Â const cy = canvas.height/2;
Â Â Â Â const mx = mid.x - rect.left;
Â Â Â Â const my = mid.y - rect.top;
Â 
Â Â Â Â camera.x = mx - cx - (pinchWorldMid.x * scale);
Â Â Â Â camera.y = my - cy 
Â Â Â Â - (pinchWorldMid.y * scale);
Â 
Â Â Â Â draw();
Â Â Â Â return;
Â Â }
Â 
Â Â if(e.touches.length !== 1) return;
Â Â const t = e.touches[0];
Â 
Â Â if(!pressStart) return;
Â 
Â Â const dx = t.clientX - pressStart.clientX;
Â Â const dy = t.clientY - pressStart.clientY;
Â Â const moved = Math.hypot(dx, dy);
Â 
Â Â const worldP = screenToWorld(t.clientX, t.clientY);
Â Â const snap = getSnapStep();
Â 
Â Â if(!dragActive && moved >= 6){
Â Â Â Â dragActive = true;
Â Â Â Â emptyTapCandidate = false;
Â Â Â Â if(longPressTimer) clearTimeout(longPressTimer);
Â Â Â Â longPressTimer = null;
Â 
Â Â Â Â gestureSnapshot = snapshot();
Â 
Â Â Â Â if(pendingItem){
Â Â Â Â Â Â items.splice(items.indexOf(pendingItem), 1);
Â Â Â Â Â Â items.push(pendingItem);
Â Â Â Â Â Â normalizeZ();
Â Â Â Â }
Â 
Â Â Â Â if(pendingAction === "moveRect" && pendingItem){
Â Â Â Â Â Â rectDragOffset = { dx: worldP.x - pendingItem.x, dy: worldP.y - pendingItem.y };
Â Â Â Â }
Â Â Â Â if(pendingAction === "moveWall" && pendingItem){
Â Â Â Â Â Â wallMoveOffset = { dx: worldP.x - pendingItem.x1, dy: worldP.y - pendingItem.y1 };
Â Â Â Â }
Â Â }
Â 
Â Â if(dragActive){
Â Â Â Â if(pendingAction === "pan"){
Â Â Â Â Â Â camera.x += dx;
Â Â Â Â Â Â camera.y += dy;
Â Â Â Â Â Â pressStart = { clientX: t.clientX, clientY: t.clientY };
Â Â Â Â Â Â draw();
Â Â Â Â Â Â return;
Â Â Â Â }
Â 
Â Â Â Â if(pendingItem && !pendingItem.locked){
Â Â Â Â Â Â if(pendingItem.type === 'wallLine'){
Â Â Â Â Â Â Â Â const w = pendingItem;
Â Â Â Â Â Â Â Â if(pendingAction === "p1"){
Â Â Â Â Â Â Â Â Â Â w.x1 = getSnapped(worldP.x, snap);
Â Â Â Â Â Â Â Â Â Â w.y1 = getSnapped(worldP.y, snap);
Â Â Â Â Â Â Â Â Â Â applyRightAngleSnap(w, "p1");
Â Â Â Â Â Â Â Â } else if(pendingAction === "p2"){
Â Â Â Â Â Â Â Â Â Â w.x2 = getSnapped(worldP.x, snap);
Â Â Â Â Â Â Â Â Â Â w.y2 = getSnapped(worldP.y, snap);
Â Â Â Â Â Â Â Â Â Â applyRightAngleSnap(w, "p2");
Â Â Â Â Â Â Â Â } else if(pendingAction === "moveWall"){
Â Â Â Â Â Â Â Â Â Â const vx = w.x2 - w.x1;
Â Â Â Â Â Â Â Â Â Â const vy = w.y2 - w.y1;
Â Â Â Â Â Â Â Â Â Â const nx1 = getSnapped(worldP.x - (wallMoveOffset?.dx ?? 0), snap);
Â Â Â Â Â Â Â Â Â Â const ny1 = getSnapped(worldP.y - (wallMoveOffset?.dy ?? 0), snap);
Â Â Â Â Â Â Â Â Â Â w.x1 = nx1; w.y1 = ny1;
Â Â Â Â Â Â Â Â Â Â w.x2 = nx1 + vx;
Â Â Â Â Â Â Â Â Â Â w.y2 = ny1 + vy;
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â }else{
Â Â Â Â Â Â Â Â const it = pendingItem;
Â Â Â Â Â Â Â Â if(pendingAction === "resizeRect"){
Â Â Â Â Â Â Â Â Â Â it.w = Math.max(snap, getSnapped(worldP.x - it.x, snap));
Â Â Â Â Â Â Â Â Â Â it.h = Math.max(snap, getSnapped(worldP.y - it.y, snap));
Â Â Â Â Â Â Â Â }else if(pendingAction === "moveRect"){
Â Â Â Â Â Â Â Â Â Â it.x = getSnapped(worldP.x - (rectDragOffset?.dx ?? 0), snap);
Â Â Â Â Â Â Â Â Â Â it.y = getSnapped(worldP.y - (rectDragOffset?.dy ?? 0), snap);
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â }
Â Â Â Â }
Â Â }
Â 
Â Â draw();
});
Â 
function commitGestureIfAny(){
Â Â if(dragActive && gestureSnapshot){
Â Â Â Â undoStack.push(gestureSnapshot);
Â Â Â Â if (undoStack.length > HISTORY_MAX) undoStack.shift();
Â Â Â Â redoStack = [];
Â Â Â Â gestureSnapshot = null;
Â Â Â Â syncHistoryButtons();
Â Â Â Â scheduleAutoSave();
Â Â }else{
Â Â Â Â gestureSnapshot = null;
Â Â }
}
Â 
canvas.addEventListener('touchend', (e) => {
Â Â if(pinchActive){
Â Â Â Â if(e.touches.length < 2){
Â Â Â Â Â Â pinchActive = false;
Â Â Â Â Â Â commitGestureIfAny();
Â Â Â Â }
Â Â Â Â clearTouchState();
Â Â Â Â draw();
Â Â Â Â return;
Â Â }
Â 
Â Â if(longPressTimer) clearTimeout(longPressTimer);
Â Â longPressTimer = null;
Â 
Â Â // â˜…ç©ºã‚¿ãƒƒãƒ—ã§é¸æŠè§£é™¤ï¼ˆãƒ‘ãƒ³ã—ãªã„å ´åˆã®ã¿ï¼‰
Â Â if(emptyTapCandidate && !dragActive){
Â Â Â Â selectedItem = null;
Â Â }
Â 
Â Â commitGestureIfAny();
Â Â clearTouchState();
Â Â draw();
});
canvas.addEventListener('touchcancel', () => {
Â Â pinchActive = false;
Â Â if(longPressTimer) clearTimeout(longPressTimer);
Â Â longPressTimer = null;
Â Â gestureSnapshot = null;
Â Â clearTouchState();
Â Â draw();
});
init();
</script>
Â 
Â 
</body></html>